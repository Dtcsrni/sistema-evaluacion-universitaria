<html>
<head>
  <title>Iniciando Dashboard…</title>
  <hta:application
    id="app"
    applicationname="DashboardSplash"
    border="thin"
    borderstyle="normal"
    caption="no"
    maximizebutton="no"
    minimizebutton="no"
    sysmenu="no"
    scroll="no"
    singleinstance="yes"
    showintaskbar="no"
    windowstate="normal"
    icon="icons\\dashboard-dev.ico"
  />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <style>
    :root{
      --bgA:#0b3a6b;
      --bgB:#1d6fb8;
      --bgC:#2fa4dd;
      --card:rgba(255,255,255,0.10);
      --card2:rgba(255,255,255,0.06);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(226,232,240,0.84);
      --ring:rgba(255,255,255,0.22);
      --ok:#22c55e;
      --bad:#ef4444;
    }
    html,body{height:100%;margin:0;overflow:hidden;font-family:Segoe UI, system-ui, -apple-system, sans-serif;}
    body{
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.22) 0, transparent 55%),
                  linear-gradient(135deg, var(--bgA), var(--bgB), var(--bgC));
    }
    .wrap{height:100%;display:grid;place-items:center;padding:18px;}
    .card{
      width: 440px;
      border-radius: 22px;
      padding: 18px 18px 16px;
      border: 1px solid rgba(255,255,255,0.22);
      background: linear-gradient(180deg, var(--card), var(--card2));
      box-shadow: 0 30px 80px rgba(0,0,0,0.28);
    }
    .row{display:flex;gap:14px;align-items:center;}
    .mark{
      width: 46px; height: 46px; border-radius: 18px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.22);
      display:grid;place-items:center;
      position:relative;
      overflow:hidden;
    }
    .mark:before{
      content:"";
      position:absolute;
      inset:-40px;
      background: radial-gradient(circle at 30% 35%, rgba(255,255,255,0.35), transparent 55%);
      animation: glow 1.6s ease-in-out infinite;
    }
    .mark svg{position:relative;display:block;}
    h1{margin:0;color:var(--text);font-size:16px;font-weight:900;letter-spacing:0.01em;}
    p{margin:6px 0 0;color:var(--muted);font-size:12px;line-height:1.35;}

    .errorBox{
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.22);
      background: rgba(15,23,42,0.20);
      display:none;
    }
    .errorTitle{color:rgba(255,255,255,0.95);font-weight:900;font-size:12px;margin:0 0 6px;}
    .errorText{color:rgba(226,232,240,0.92);font-size:12px;line-height:1.35;margin:0;}
    code{font-family:Consolas, ui-monospace, SFMono-Regular, Menlo, monospace;color:rgba(255,255,255,0.92);}
    .actions{display:flex;gap:8px;margin-top:12px;}
    .btn{flex:1;border-radius: 12px; padding: 9px 10px; cursor:pointer; border:1px solid rgba(255,255,255,0.22);
      background: rgba(255,255,255,0.10); color: rgba(255,255,255,0.92); font-weight:900; font-size:12px;
    }
    .btn:hover{background: rgba(255,255,255,0.14);}
    .btn.primary{background: rgba(34,197,94,0.18); border-color: rgba(34,197,94,0.35);}
    .btn.danger{background: rgba(239,68,68,0.18); border-color: rgba(239,68,68,0.35);}

    .loader{
      margin-top: 14px;
      height: 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.18);
      overflow:hidden;
      position:relative;
    }
    .bar{
      position:absolute; inset:0;
      width: 38%;
      background: linear-gradient(90deg, rgba(255,255,255,0.10), rgba(255,255,255,0.55), rgba(255,255,255,0.10));
      transform: translateX(-60%);
      animation: move 1.05s ease-in-out infinite;
    }

    .steps{display:flex;gap:8px;align-items:center;margin-top:12px;}
    .dot{width:8px;height:8px;border-radius:999px;background:rgba(255,255,255,0.20);border:1px solid rgba(255,255,255,0.20);}
    .dot.on{background:rgba(255,255,255,0.70);}
    .status{color:var(--muted);font-size:12px;flex:1;min-width:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

    @keyframes move{0%{transform:translateX(-60%);}50%{transform:translateX(130%);}100%{transform:translateX(130%);}}
    @keyframes glow{0%,100%{opacity:0.45;}50%{opacity:1;}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <div class="mark" aria-hidden="true">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64" width="34" height="34" role="img" aria-label="Sistema de Evaluación">
            <defs>
              <linearGradient id="bg" x1="10" y1="6" x2="54" y2="58" gradientUnits="userSpaceOnUse">
                <stop offset="0" stop-color="#0b3a6b"/>
                <stop offset="0.58" stop-color="#1d6fb8"/>
                <stop offset="1" stop-color="#2fa4dd"/>
              </linearGradient>
              <linearGradient id="cap" x1="22" y1="12" x2="46" y2="32" gradientUnits="userSpaceOnUse">
                <stop offset="0" stop-color="#ffffff" stop-opacity="0.98"/>
                <stop offset="1" stop-color="#e6f0fb" stop-opacity="0.98"/>
              </linearGradient>
              <filter id="soft" x="-20%" y="-20%" width="140%" height="140%">
                <feGaussianBlur stdDeviation="1.2" result="b"/>
                <feColorMatrix in="b" type="matrix" values="1 0 0 0 0  0 1 0 0 0  0 0 1 0 0  0 0 0 0.20 0"/>
                <feMerge>
                  <feMergeNode/>
                  <feMergeNode in="SourceGraphic"/>
                </feMerge>
              </filter>
            </defs>

            <rect x="6" y="6" width="52" height="52" rx="14" fill="url(#bg)"/>
            <circle cx="32" cy="34" r="18" fill="#ffffff" opacity="0.10" filter="url(#soft)"/>
            <rect x="18" y="30" width="28" height="20" rx="6" fill="#ffffff" opacity="0.96"/>
            <path d="M22 36h12" stroke="#94a3b8" stroke-width="2.6" stroke-linecap="round" opacity="0.85"/>
            <path d="M22 41h9" stroke="#94a3b8" stroke-width="2.6" stroke-linecap="round" opacity="0.72"/>
            <path d="M22 46h7v-4h8v4h7" fill="none" stroke="#22c55e" stroke-width="2.6" stroke-linecap="round" stroke-linejoin="round"/>
            <circle cx="22" cy="46" r="2.2" fill="#22c55e"/>
            <circle cx="29" cy="46" r="2.2" fill="#22c55e"/>
            <circle cx="37" cy="42" r="2.2" fill="#22c55e"/>
            <circle cx="45" cy="46" r="2.2" fill="#22c55e"/>
            <path d="M32 14l16 7-16 7-16-7 16-7Z" fill="url(#cap)"/>
            <path d="M24 25v4c0 2.2 3.6 4 8 4s8-1.8 8-4v-4" fill="#cfe3f7" opacity="0.95"/>
            <path d="M48 21v7" stroke="#f8fafc" stroke-width="2.2" stroke-linecap="round" opacity="0.9"/>
            <circle cx="48" cy="29" r="2.2" fill="#f8fafc" opacity="0.95"/>
          </svg>
        </div>
        <div>
          <h1>Iniciando Sistema de Evaluación</h1>
          <p id="subtitle">Preparando dashboard local y verificando servicios…</p>
        </div>
      </div>

      <div class="loader" aria-hidden="true"><div class="bar"></div></div>

      <div class="steps">
        <span class="dot on" id="d1"></span>
        <span class="dot" id="d2"></span>
        <span class="dot" id="d3"></span>
        <span class="dot" id="d4"></span>
        <div class="status" id="status">Cargando…</div>
      </div>

      <div class="errorBox" id="errorBox" role="status" aria-live="polite">
        <p class="errorTitle" id="errorTitle">No se pudo conectar</p>
        <p class="errorText" id="errorText"></p>
        <div class="actions">
          <button class="btn primary" type="button" id="btnRetry">Reintentar</button>
          <button class="btn" type="button" id="btnLogs">Abrir logs</button>
          <button class="btn danger" type="button" id="btnClose">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    window.resizeTo(480, 290);
    try {
      var x = (screen.availWidth - 480) / 2;
      var y = (screen.availHeight - 290) / 2;
      window.moveTo(x, y);
    } catch (e) {}

    function parseQuery() {
      var q = (document.location.search || '').replace(/^\?/, '');
      var obj = {};
      if (!q) return obj;
      var parts = q.split('&');
      for (var i = 0; i < parts.length; i++) {
        var kv = parts[i].split('=');
        if (kv.length >= 2) obj[decodeURIComponent(kv[0])] = decodeURIComponent(kv.slice(1).join('='));
      }
      return obj;
    }

    function setHtaIconByMode(mode) {
      try {
        if (mode === 'prod') {
          app.icon = 'icons\\dashboard-prod.ico';
        } else {
          app.icon = 'icons\\dashboard-dev.ico';
        }
      } catch (e) {}
    }

    function getRootDir() {
      // location.pathname in HTA: /V:/path/to/scripts/dashboard-splash.hta
      var p = (document.location.pathname || '').replace(/\//g, '\\');
      // Remove leading backslash if present.
      if (p.charAt(0) === '\\') p = p.substring(1);
      // Strip file name.
      var last = p.lastIndexOf('\\');
      var dir = last >= 0 ? p.substring(0, last) : p;
      // dir ends with \scripts
      var scriptsIdx = dir.toLowerCase().lastIndexOf('\\scripts');
      if (scriptsIdx >= 0) return dir.substring(0, scriptsIdx);
      return dir;
    }

    function httpOk(url) {
      try {
        var req = new ActiveXObject('WinHttp.WinHttpRequest.5.1');
        req.Open('GET', url, false);
        req.SetTimeouts(300, 300, 300, 700);
        req.Send();
        var st = Number(req.Status);
        if (st >= 200 && st < 500) return { ok: true, status: st };
        return { ok: false, status: st };
      } catch (e) {
        return { ok: false, error: String(e && e.message ? e.message : e) };
      }
    }

    var msgs = [
      'Inicializando dashboard…',
      'Levantando servidor local…',
      'Verificando conexión…',
      'Cargando interfaz…'
    ];

    var idx = 0;
    var dots = [document.getElementById('d1'), document.getElementById('d2'), document.getElementById('d3'), document.getElementById('d4')];
    var status = document.getElementById('status');

    function tick(){
      idx = (idx + 1) % msgs.length;
      status.textContent = msgs[idx];
      for (var i=0;i<dots.length;i++) dots[i].className = 'dot' + (i<=idx ? ' on' : '');
    }

    var intervalId = setInterval(tick, 650);

    var q = parseQuery();
    var port = Number(q.port || 4519);
    var mode = String(q.mode || 'dev');
    setHtaIconByMode(mode);

    var urlStatus = 'http://127.0.0.1:' + port + '/api/status';
    var urlHome = 'http://127.0.0.1:' + port + '/';
    var startedAt = new Date().getTime();
    var timeoutMs = 24000;
    var errorBox = document.getElementById('errorBox');
    var errorTitle = document.getElementById('errorTitle');
    var errorText = document.getElementById('errorText');
    var subtitle = document.getElementById('subtitle');

    function showError(last) {
      try { clearInterval(intervalId); } catch (e) {}
      subtitle.textContent = 'No se pudo verificar el dashboard local.';
      errorTitle.textContent = 'No se pudo conectar en ~24s';
      var detalles = '';
      if (last && last.error) detalles = 'Ultimo error: ' + last.error;
      if (last && last.status) detalles = 'HTTP: ' + last.status;

      errorText.innerHTML =
        'No hubo respuesta en <code>' + urlStatus + '</code>.<br/>' +
        'Sugerencias: confirma que Docker/servicios esten levantados, y que el puerto <code>' + port + '</code> no este ocupado.<br/>' +
        (detalles ? (detalles + '<br/>') : '') +
        'Puedes reintentar o abrir la carpeta de logs para ver el detalle.';
      errorBox.style.display = 'block';
      status.textContent = 'Sin conexion.';
      for (var i=0;i<dots.length;i++) dots[i].className = 'dot';
    }

    function openLogs() {
      try {
        var root = getRootDir();
        var sh = new ActiveXObject('WScript.Shell');
        sh.Run('explorer.exe "' + root + '\\logs"', 1, false);
      } catch (e) {}
    }

    function retry() {
      errorBox.style.display = 'none';
      subtitle.textContent = 'Preparando dashboard local y verificando servicios…';
      startedAt = new Date().getTime();
      intervalId = setInterval(tick, 650);
      poll();
    }

    document.getElementById('btnRetry').onclick = retry;
    document.getElementById('btnLogs').onclick = openLogs;
    document.getElementById('btnClose').onclick = function(){ try { window.close(); } catch (e) {} };

    function poll() {
      var now = new Date().getTime();
      var last = httpOk(urlStatus);
      if (last.ok) {
        // El launcher VBS abre el navegador y cierra este splash.
        return;
      }
      if ((now - startedAt) >= timeoutMs) {
        showError(last);
        return;
      }
      setTimeout(poll, 450);
    }

    // Start polling immediately.
    poll();
  </script>
</body>
</html>
