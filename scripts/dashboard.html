<!doctype html>
<!--
  Dashboard UI for local control.
  - Talks to the local Node server on /api/*.
  - Focuses on main functions, with detailed status in a separate tab.
  - Uses large controls for laptop screens and safe hold-to-toggle actions.
-->
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/svg+xml" href="/assets/dashboard-icon.svg" />
  <link rel="apple-touch-icon" href="/assets/dashboard-icon.svg" />
  <link rel="manifest" href="/manifest.webmanifest" />
  <title>Dashboard - Sistema de Evaluacion Universitaria</title>
  <style>
    :root {
      --bg: #f5f7fb;
      --panel: #ffffff;
      --ink: #182232;
      --ink-soft: #4b6278;
      --accent: #0b3a6b;
      --accent-2: #1d6fb8;
      --accent-3: #2fa4dd;
      --accent-soft: #e6f0fb;
      --warn: #fff2f1;
      --ok: #e9f7ef;
      --border: #d5e2ef;
      --shadow: 0 10px 24px rgba(15, 23, 42, 0.1);
    }

    * { box-sizing: border-box; }

    button:focus-visible,
    a:focus-visible,
    input:focus-visible,
    select:focus-visible,
    textarea:focus-visible {
      outline: 3px solid rgba(47, 164, 221, 0.9);
      outline-offset: 3px;
      box-shadow: 0 0 0 4px rgba(47, 164, 221, 0.18);
    }

    body {
      margin: 0;
      font-family: "Trebuchet MS", "Candara", sans-serif;
      font-size: 15px;
      background: radial-gradient(circle at 12% 18%, #eaf2ff, transparent 40%),
                  radial-gradient(circle at 88% 12%, #eef9ff, transparent 30%),
                  linear-gradient(180deg, #f7fbff 0%, #f5f7fb 100%);
      color: var(--ink);
    }

    header {
      background: linear-gradient(120deg, #0b3a6b, #1d6fb8 60%, #2fa4dd);
      color: #ffffff;
      padding: 18px 22px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 16px;
      position: sticky;
      top: 0;
      z-index: 3;
      box-shadow: 0 6px 18px rgba(15, 23, 42, 0.25);
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo {
      width: 46px;
      height: 46px;
      background: rgba(255, 255, 255, 0.12);
      border-radius: 14px;
      display: grid;
      place-items: center;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2);
      position: relative;
      overflow: hidden;
    }

    .logo:before {
      content: "";
      position: absolute;
      inset: -40px;
      background: radial-gradient(circle at 30% 35%, rgba(255,255,255,0.26), transparent 60%);
      opacity: 0.85;
      animation: logoGlow 1.9s ease-in-out infinite;
    }

    .logo:after {
      content: "";
      position: absolute;
      inset: -120% -120% -120% -120%;
      background: linear-gradient(120deg, transparent, rgba(255,255,255,0.22), transparent);
      transform: translateX(-30%) rotate(12deg);
      animation: logoSheen 2.8s ease-in-out infinite;
      opacity: 0.75;
      pointer-events: none;
    }

    .logo svg {
      position: relative;
      width: 30px;
      height: 30px;
      overflow: visible;
    }

    .logo .stroke {
      fill: none;
      stroke: rgba(255,255,255,0.96);
      stroke-width: 1.9;
      stroke-linecap: round;
      stroke-linejoin: round;
    }

    .logo .accent {
      fill: none;
      stroke: rgba(34, 197, 94, 0.98);
      stroke-width: 2.2;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 26 52;
      animation: circuitDash 1.15s ease-in-out infinite;
    }

    .logo .node {
      fill: rgba(34, 197, 94, 0.98);
      opacity: 0.95;
      animation: nodePulse 1.15s ease-in-out infinite;
    }

    .logo .node.n2 { animation-delay: 0.12s; }
    .logo .node.n3 { animation-delay: 0.24s; }
    .logo .node.n4 { animation-delay: 0.36s; }

    @keyframes logoGlow {
      0%,100% { transform: scale(1); opacity: 0.72; }
      50% { transform: scale(1.05); opacity: 1; }
    }

    @keyframes logoSheen {
      0% { transform: translateX(-35%) rotate(12deg); opacity: 0.0; }
      30% { opacity: 0.55; }
      55% { opacity: 0.25; }
      100% { transform: translateX(40%) rotate(12deg); opacity: 0.0; }
    }

    @keyframes circuitDash {
      0% { stroke-dashoffset: 0; opacity: 0.92; }
      50% { opacity: 1; }
      100% { stroke-dashoffset: -52; opacity: 0.92; }
    }

    @keyframes nodePulse {
      0%,100% { transform: scale(1); opacity: 0.85; }
      50% { transform: scale(1.15); opacity: 1; }
    }

    .title {
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.3px;
    }

    .subtitle {
      font-size: 12px;
      opacity: 0.96;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.28);
    }

    .header-chips {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chip {
      background: rgba(0, 0, 0, 0.24);
      border: 1px solid rgba(255, 255, 255, 0.22);
      color: #ffffff;
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      text-shadow: 0 1px 1px rgba(0, 0, 0, 0.28);
    }

    .chip.ok {
      border-color: rgba(34, 197, 94, 0.7);
    }

    .chip.warn {
      border-color: rgba(245, 158, 11, 0.75);
    }

    .chip.error {
      border-color: rgba(239, 68, 68, 0.75);
    }

    .mono {
      font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      font-size: 12px;
      color: var(--ink);
      word-break: break-all;
    }

    .install-grid {
      display: grid;
      gap: 10px;
      margin-top: 10px;
    }

    .install-row {
      display: grid;
      grid-template-columns: 140px minmax(0, 1fr);
      gap: 10px;
      align-items: start;
      padding: 10px 12px;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(11, 58, 107, 0.04), rgba(47, 164, 221, 0.02));
    }

    .install-row .k {
      color: var(--ink-soft);
      font-weight: 800;
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.06em;
    }

    .install-row .v {
      color: var(--ink);
      font-weight: 700;
      font-size: 13px;
      line-height: 1.35;
    }

    main {
      padding: clamp(12px, 2vw, 22px) clamp(12px, 2.6vw, 28px) 30px;
      max-width: 2200px;
      margin: 0 auto;
    }

    .tabs {
      display: flex;
      gap: 12px;
      margin: 12px 0 18px;
      flex-wrap: wrap;
    }

    .tab-btn {
      background: #ffffff;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 10px 18px;
      font-size: 13px;
      font-weight: 700;
      color: var(--ink-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s ease;
    }

    .tab-btn.active {
      color: #ffffff;
      background: linear-gradient(120deg, #0b3a6b, #1d6fb8);
      box-shadow: 0 8px 16px rgba(13, 58, 107, 0.3);
      transform: translateY(-1px);
    }

    .tab-panel {
      display: none;
      animation: fadeUp 0.35s ease both;
    }

    .tab-panel[hidden] { display: none; }

    .tab-panel.active { display: block; }

    .panel-grid {
      display: grid;
      grid-template-columns: minmax(240px, 320px) minmax(0, 1fr);
      gap: 20px;
      align-items: start;
    }

    @media (min-width: 1101px) {
      .panel-grid { grid-template-columns: minmax(320px, 420px) minmax(0, 1fr); }
    }

    @media (min-width: 1500px) {
      .panel-grid { grid-template-columns: minmax(360px, 480px) minmax(0, 1fr); }
    }

    .left-col {
      display: grid;
      gap: 16px;
      align-content: start;
    }

    .right-grid {
      display: grid;
      gap: 16px;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      grid-auto-flow: row dense;
      align-items: start;
    }

    .right-grid .card {
      grid-column: span 12;
      margin-top: 0;
    }

    .right-grid .card.wide { grid-column: 1 / -1; }

    .card.wide { grid-column: 1 / -1; }

    .card {
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      animation: fadeUp 0.35s ease both;
    }

    .card::after {
      content: '';
      position: absolute;
      top: -40%;
      right: -30%;
      width: 180px;
      height: 180px;
      background: radial-gradient(circle, rgba(47, 164, 221, 0.12), transparent 70%);
      pointer-events: none;
    }

    .card + .card { margin-top: 0; }

    .alert-card { border-left: 4px solid #f59e0b; }
    .alert-card.ok { border-left-color: #22c55e; }
    .alert-card.error { border-left-color: #ef4444; }
    .alert-body { display: flex; gap: 16px; align-items: flex-start; }
    .alert-icon {
      width: 42px;
      height: 42px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      background: rgba(245, 158, 11, 0.14);
      color: #b45309;
      font-weight: 800;
      font-size: 18px;
    }
    .alert-card.ok .alert-icon { background: rgba(34, 197, 94, 0.14); color: #166534; }
    .alert-card.error .alert-icon { background: rgba(239, 68, 68, 0.14); color: #b91c1c; }
    .alert-content { flex: 1; min-width: 0; }
    .alert-content h3 { margin: 0; font-size: 15px; }
    .alert-content p { margin: 6px 0 0; color: var(--ink-soft); font-size: 13px; }
    .alert-meta {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 11px;
      color: var(--ink-soft);
    }
    .alert-actions { display: flex; gap: 8px; align-items: center; }
    button.ghost-btn {
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--ink);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 700;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      line-height: 1.2;
      transition: transform 90ms ease, box-shadow 140ms ease, background 140ms ease, border-color 140ms ease, color 140ms ease;
    }
    button.ghost-btn:hover { box-shadow: 0 8px 16px rgba(15, 23, 42, 0.12); }
    button.ghost-btn:active { transform: translateY(1px) scale(0.995); }

    button.ghost-btn.pending {
      opacity: 0.88;
      box-shadow: 0 10px 22px rgba(15, 23, 42, 0.10);
      border-color: rgba(15, 23, 42, 0.12);
    }

    button.ghost-btn[data-hold-ms] {
      position: relative;
      overflow: hidden;
    }

    button.ghost-btn[data-hold-ms]::before {
      content: '';
      position: absolute;
      inset: -1px;
      background:
        radial-gradient(circle at 20% 50%, rgba(47, 164, 221, 0.18), transparent 55%),
        radial-gradient(circle at 80% 30%, rgba(13, 58, 107, 0.10), transparent 60%);
      opacity: 0;
      transition: opacity 140ms ease;
      pointer-events: none;
      z-index: 0;
    }

    button.ghost-btn.is-holding::before { opacity: 1; }

    button.ghost-btn > * {
      position: relative;
      z-index: 1;
    }

    button.ghost-btn[data-hold-ms]::after {
      content: '';
      position: absolute;
      inset: 0;
      width: calc(var(--hold, 0) * 1%);
      background: linear-gradient(90deg, rgba(13, 58, 107, 0.16), rgba(13, 58, 107, 0.06));
      z-index: 0;
      pointer-events: none;
      transition: width 0.05s linear;
    }

    button.ghost-btn.is-holding {
      box-shadow: 0 10px 22px rgba(13, 58, 107, 0.18);
    }

    button.ghost-btn.hold-btn {
      padding: 10px 14px;
      gap: 2px;
      flex-direction: column;
      border-radius: 16px;
      min-width: 150px;
    }

    button.ghost-btn.hold-btn .btn-row {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    button.ghost-btn.hold-btn .btn-sub {
      font-size: 11px;
      font-weight: 700;
      color: var(--ink-soft);
      opacity: 0.95;
    }

    button.ghost-btn.restart-btn {
      background: #fff7ed;
      border-color: #fed7aa;
      color: #7c2d12;
    }

    button.ghost-btn.restart-btn:hover {
      background: #ffedd5;
      border-color: #fdba74;
    }

    button.ghost-btn.restart-btn.is-holding {
      box-shadow: 0 12px 24px rgba(124, 45, 18, 0.18);
    }

    button.ghost-btn.hold-done {
      animation: holdDone 0.36s ease both;
    }

    @keyframes holdDone {
      0% { transform: translateY(0) scale(1); }
      45% { transform: translateY(-1px) scale(1.02); }
      100% { transform: translateY(0) scale(1); }
    }

    .signal-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }
    .signal-pill {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      font-weight: 700;
      color: var(--ink-soft);
      background: #f8fbff;
    }
    .signal-pill span { font-size: 16px; color: var(--ink); }
    .signal-pill.error { background: #fff1f2; border-color: #fecdd3; color: #b91c1c; }
    .signal-pill.warn { background: #fff7ed; border-color: #fed7aa; color: #9a3412; }
    .signal-pill.ok { background: #ecfdf3; border-color: #bbf7d0; color: #166534; }
    .signal-pill.info { background: #eef6ff; border-color: #c7ddf5; color: #1d4f91; }

    .event-feed { list-style: none; margin: 0; padding: 0; display: grid; gap: 10px; }
    .event-item {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #ffffff;
    }
    .event-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-top: 6px;
      background: #94a3b8;
      box-shadow: 0 0 0 4px rgba(148, 163, 184, 0.2);
    }
    .event-item.error .event-dot { background: #ef4444; box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.2); }
    .event-item.warn .event-dot { background: #f59e0b; box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.2); }
    .event-item.ok .event-dot { background: #22c55e; box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2); }
    .event-item.info .event-dot { background: #0ea5e9; box-shadow: 0 0 0 4px rgba(14, 165, 233, 0.2); }
    .event-text { flex: 1; font-size: 13px; color: var(--ink); }
    .event-meta { margin-top: 4px; font-size: 11px; color: var(--ink-soft); display: flex; gap: 10px; flex-wrap: wrap; }
    .event-time { margin-left: auto; font-size: 11px; color: var(--ink-soft); }
    .event-empty { padding: 12px; border: 1px dashed var(--border); border-radius: 12px; color: var(--ink-soft); font-size: 12px; }

    @media (max-width: 900px) {
      .alert-body { flex-direction: column; }
      .alert-actions { width: 100%; justify-content: flex-start; }
    }

    .card h2 {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 0 0 12px 0;
      color: var(--ink-soft);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon {
      width: 16px;
      height: 16px;
      fill: var(--accent-2);
    }

    .stack { display: grid; gap: 12px; }

    .actions {
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px dashed var(--border);
      display: grid;
      gap: 10px;
    }

    .actions-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .actions-grid .ghost-btn {
      width: 100%;
    }

    @media (min-width: 360px) {
      .actions-grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (min-width: 620px) {
      .actions-grid.env { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    .hint {
      font-size: 12px;
      color: var(--ink-soft);
      margin: 0 0 12px 0;
    }

    button {
      border: 1px solid var(--border);
      background: var(--accent-soft);
      padding: 12px 14px;
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: transform 0.08s ease, background 0.2s ease, box-shadow 0.2s ease;
    }

    button:hover { background: #d9e9ff; box-shadow: 0 8px 16px rgba(13, 58, 107, 0.15); }
    button:active { transform: translateY(1px); }

    button.danger { background: var(--warn); }
    button.ok { background: var(--ok); }

    .toggle-btn {
      position: relative;
      overflow: hidden;
      display: grid;
      grid-template-columns: 28px minmax(0, 1fr) auto;
      align-items: center;
      gap: 12px;
      min-height: 72px;
      background: #f4f9ff;
    }

    .toggle-btn::after {
      content: '';
      position: absolute;
      inset: 0;
      width: calc(var(--hold, 0) * 1%);
      background: linear-gradient(90deg, rgba(13, 58, 107, 0.18), rgba(13, 58, 107, 0.06));
      pointer-events: none;
      transition: width 0.05s linear;
    }

    .toggle-btn.active { background: #eef7ff; }
    .toggle-btn.pending { opacity: 0.85; }

    .toggle-meta {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
      z-index: 1;
    }

    .toggle-title {
      font-size: 15px;
      font-weight: 700;
      line-height: 1.2;
    }
    .toggle-sub {
      font-size: 12px;
      color: var(--ink-soft);
      line-height: 1.2;
    }

    @media (min-width: 620px) {
      .toggle-title,
      .toggle-sub {
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
      }
    }

    .toggle-state {
      font-size: 12px;
      font-weight: 700;
      color: var(--ink-soft);
      padding: 6px 10px;
      border-radius: 999px;
      background: #eef3f9;
      border: 1px solid var(--border);
      z-index: 1;
    }

    .toggle-btn.active .toggle-state {
      background: #e9f7ef;
      color: #1f6b3a;
      border-color: #bde6cd;
    }

    .toggle-btn.pending .toggle-state {
      background: #fff6e6;
      color: #8a5800;
      border-color: #ffd9a8;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #94a3b8;
      box-shadow: 0 0 0 4px rgba(148, 163, 184, 0.15);
      z-index: 1;
    }

    .toggle-btn.active .status-dot {
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
      animation: pulse 1.6s ease-in-out infinite;
    }

    .links {
      display: grid;
      gap: 12px;
    }

    .link-item {
      background: #f8fbff;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    }

    .link-item.inactive {
      border-style: dashed;
      opacity: 0.6;
    }

    .link-item a {
      display: flex;
      align-items: center;
      gap: 12px;
      text-decoration: none;
      color: var(--ink);
      font-weight: 700;
    }

    .link-item .icon {
      fill: var(--accent-2);
    }

    .link-copy {
      display: grid;
      gap: 2px;
    }

    .link-title {
      font-size: 14px;
      color: var(--ink);
    }

    .link-meta {
      font-size: 12px;
      color: var(--ink-soft);
      font-weight: 600;
    }

    .link-chip {
      margin-left: auto;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      border: 1px solid var(--border);
      background: #eef3f9;
      color: var(--ink-soft);
    }

    .link-chip.dev {
      background: #e8f3ff;
      color: #0b3a6b;
      border-color: #c7ddf6;
    }

    .link-chip.prod {
      background: #e9f7ef;
      color: #1f6b3a;
      border-color: #bde6cd;
    }

    .link-chip.api {
      background: #fff3e6;
      color: #8a5800;
      border-color: #ffd9a8;
    }

    .link-note {
      margin-left: 32px;
      margin-top: 6px;
      font-size: 12px;
      color: var(--ink-soft);
    }

    .link-status {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-left: 32px;
      margin-top: 6px;
      font-size: 12px;
      color: var(--ink-soft);
    }

    .health-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #94a3b8;
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.16);
    }

    .health-dot.ok {
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .health-dot.down {
      background: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
    }

    .health-text {
      font-weight: 700;
      color: var(--ink);
    }

    .health-latency {
      margin-left: auto;
      font-weight: 600;
      color: var(--ink-soft);
    }

    .metrics {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
    }

    .metric {
      background: #f7fafd;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      display: grid;
      gap: 6px;
      min-height: 78px;
      position: relative;
      overflow: hidden;
    }

    .metric::after {
      content: '';
      position: absolute;
      inset: auto -20% -45% -20%;
      height: 70%;
      background: linear-gradient(120deg, rgba(47, 164, 221, 0.12), transparent 70%);
    }

    .metric .label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--ink-soft);
    }

    .metric .value {
      font-size: 18px;
      font-weight: 700;
      color: var(--ink);
    }

    .summary-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-bottom: 12px;
    }

    .summary-card {
      background: linear-gradient(135deg, #eef4ff, #ffffff);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      display: grid;
      gap: 6px;
    }

    .summary-card .label {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--ink-soft);
      letter-spacing: 0.6px;
    }

    .summary-card .value {
      font-size: 18px;
      font-weight: 700;
    }

    .analytics-grid {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .chart-block {
      margin-top: 12px;
      display: grid;
      gap: 8px;
    }

    .chart-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--ink-soft);
    }

    .mini-chart {
      display: flex;
      align-items: flex-end;
      gap: 6px;
      height: 72px;
      padding: 6px 0;
    }
    .mini-bar {
      width: 10px;
      border-radius: 6px 6px 4px 4px;
      background: linear-gradient(180deg, #16a34a, #4ade80);
      opacity: 0.85;
    }

    .mini-bar.down {
      background: linear-gradient(180deg, #f59e0b, #f97316);
      opacity: 0.75;
    }

    .activity-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 8px;
    }

    .activity-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f8fbff;
    }

    .activity-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #94a3b8;
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.16);
    }

    .activity-dot.ok {
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .activity-dot.warn {
      background: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }

    .activity-dot.down {
      background: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
    }

    .activity-text {
      font-weight: 600;
      color: var(--ink);
    }

    .activity-time {
      margin-left: auto;
      font-size: 12px;
      color: var(--ink-soft);
      font-weight: 600;
    }

    .activity-empty {
      font-size: 12px;
      color: var(--ink-soft);
      padding: 12px;
      text-align: center;
      border: 1px dashed var(--border);
      border-radius: 12px;
      background: #f8fbff;
    }

    .chart-empty {
      font-size: 12px;
      color: var(--ink-soft);
      padding: 10px;
      border: 1px dashed var(--border);
      border-radius: 12px;
      width: 100%;
      text-align: center;
      background: #f8fbff;
    }

    .service-list {
      display: grid;
      gap: 10px;
    }

    .service-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f8fbff;
    }

    .service-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: #94a3b8;
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.16);
    }

    .service-dot.ok {
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .service-dot.down {
      background: #ef4444;
      box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.18);
    }

    .service-copy {
      display: grid;
      gap: 2px;
    }

    .service-title {
      font-weight: 700;
      font-size: 13px;
    }

    .service-meta {
      font-size: 12px;
      color: var(--ink-soft);
      font-weight: 600;
    }

    .service-badge {
      margin-left: auto;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.4px;
      text-transform: uppercase;
      border: 1px solid var(--border);
      background: #eef3f9;
      color: var(--ink-soft);
    }

    .service-badge.ok {
      background: #e9f7ef;
      color: #1f6b3a;
      border-color: #bde6cd;
    }

    .service-badge.down {
      background: #fff1f2;
      color: #9f1239;
      border-color: #fecdd3;
    }

    .legend {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 6px;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--ink-soft);
      font-weight: 600;
    }

    .legend-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #94a3b8;
      box-shadow: 0 0 0 3px rgba(148, 163, 184, 0.16);
    }

    .legend-dot.ok {
      background: #22c55e;
      box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
    }

    .legend-dot.down {
      background: #f59e0b;
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.2);
    }
    .quote {
      background: linear-gradient(135deg, #edf4ff, #ffffff);
      border: 1px solid rgba(29, 111, 184, 0.18);
      border-radius: 16px;
      padding: 16px 18px;
      display: grid;
      gap: 8px;
      position: relative;
      overflow: hidden;
    }

    .quote-tag {
      align-self: start;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--accent);
      background: var(--accent-soft);
      border: 1px solid rgba(29, 111, 184, 0.2);
      padding: 4px 10px;
      border-radius: 999px;
    }

    .quote-text {
      margin: 0;
      font-size: 16px;
      line-height: 1.5;
      color: var(--ink);
      font-weight: 600;
    }

    .quote-author {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--ink-soft);
    }

    .status-grid {
      display: grid;
      gap: 8px;
      font-size: 14px;
      color: var(--ink-soft);
    }

    .status-grid span {
      color: var(--ink);
      font-weight: 700;
    }

    .log-shell {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: #0f172a;
      color: #e2e8f0;
      overflow: hidden;
      transition: max-height 0.3s ease, opacity 0.3s ease;
    }

    .log-shell.collapsed {
      max-height: 0;
      opacity: 0;
      padding: 0;
      border: none;
    }

    .log-body {
      padding: 14px;
      height: clamp(360px, 46vh, 720px);
      overflow: auto;
      font-family: Consolas, monospace;
      font-size: 12px;
    }

    .status-events {
      border: 1px solid var(--border);
      border-radius: 16px;
      background: #ffffff;
      padding: 12px;
      margin: 10px 0 12px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.6);
    }

    .status-events-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 8px;
    }

    .status-events-title {
      font-weight: 900;
      color: var(--ink);
      font-size: 13px;
    }

    .status-events-sub {
      font-size: 12px;
      color: var(--ink-soft);
      margin-bottom: 10px;
    }

    .status-events-list {
      display: grid;
      gap: 8px;
    }

    .status-event {
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 12px;
      background: #f8fbff;
      display: grid;
      gap: 4px;
    }

    .status-event .top {
      display: flex;
      gap: 10px;
      align-items: baseline;
      flex-wrap: wrap;
    }

    .status-event .time {
      font-weight: 900;
      color: var(--ink);
      font-size: 12px;
    }

    .status-event .tag {
      font-size: 11px;
      font-weight: 900;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--ink-soft);
    }

    .status-event.error { border-color: rgba(239, 68, 68, 0.28); background: rgba(254, 226, 226, 0.40); }
    .status-event.warn { border-color: rgba(245, 158, 11, 0.28); background: rgba(255, 237, 213, 0.45); }
    .status-event.ok { border-color: rgba(34, 197, 94, 0.26); background: rgba(220, 252, 231, 0.45); }

    .status-event .msg {
      font-size: 12px;
      color: var(--ink);
      font-weight: 700;
    }

    .status-event .meta {
      font-size: 11px;
      color: var(--ink-soft);
      white-space: pre-wrap;
      word-break: break-word;
      display: none;
    }

    .status-event.has-meta { cursor: pointer; }
    .status-event.has-meta:hover { box-shadow: 0 10px 18px rgba(15, 23, 42, 0.08); }
    .status-event.open .meta { display: block; }

    .log-line {
      padding: 4px 0;
      border-bottom: 1px dashed rgba(226, 232, 240, 0.12);
      animation: fadeIn 0.2s ease both;
    }

    .log-line.has-meta { cursor: pointer; }
    .log-line.has-meta:hover { background: rgba(255, 255, 255, 0.04); }
    .log-line.open { background: rgba(255, 255, 255, 0.03); }

    .log-line .meta { color: #94a3b8; margin-right: 6px; }
    .log-line .meta-tag {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-right: 6px;
      opacity: 0.9;
    }

    .log-line .pill {
      border: 1px solid rgba(226, 232, 240, 0.22);
      background: rgba(15, 23, 42, 0.16);
      color: #e2e8f0;
      border-radius: 999px;
      padding: 2px 7px;
      font-size: 10px;
      font-weight: 900;
      letter-spacing: 0.02em;
    }

    .log-line .meta-json {
      margin-top: 6px;
      white-space: pre-wrap;
      word-break: break-word;
      color: #cbd5e1;
      opacity: 0.95;
      display: none;
    }

    .log-line.open .meta-json { display: block; }
    .log-line.error { color: #fecaca; }
    .log-line.warn { color: #fde68a; }
    .log-line.ok { color: #bbf7d0; }
    .log-line.system { color: #bae6fd; }

    .toolbar {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 12px;
    }

    .toolbar-grid {
      display: grid;
      gap: 10px;
      align-items: center;
      grid-template-columns: 1fr;
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
      min-width: 0;
    }

    .toolbar-group.actions button {
      flex: 1 1 160px;
    }

    .toolbar-group.switches {
      row-gap: 8px;
    }

    .toolbar-group.filter {
      width: 100%;
    }

    .toolbar-group.filter .search {
      flex: 999 1 260px;
      min-width: 160px;
    }

    .toolbar-group.filter button {
      flex: 0 0 auto;
    }

    @media (min-width: 720px) {
      .toolbar-grid {
        grid-template-columns: minmax(0, 1fr);
      }
      .toolbar-group.actions button {
        flex: 0 0 auto;
      }
    }

    @media (min-width: 1101px) {
      .toolbar-grid {
        grid-template-columns: auto minmax(320px, 1fr) minmax(360px, 520px);
        column-gap: 12px;
      }
      .toolbar-group.filter {
        justify-content: flex-end;
      }
    }

    @media (min-width: 1500px) {
      .toolbar-grid {
        grid-template-columns: auto minmax(420px, 1fr) minmax(520px, 720px);
      }
    }

    .toolbar.top-space {
      margin-top: 12px;
    }

    .toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 12px;
      color: var(--ink-soft);
      font-weight: 600;
    }

    .toggle input { accent-color: var(--accent-2); }

    .search {
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      min-width: 180px;
      flex: 999 1 320px;
    }

    .pills { display: flex; gap: 10px; flex-wrap: wrap; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #eef3f9;
      border: 1px solid var(--border);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 700;
      color: var(--ink-soft);
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #94a3b8;
    }

    .dot.active {
      background: #22c55e;
      animation: pulse 1.6s ease-in-out infinite;
    }

    .toast-wrap {
      position: fixed;
      top: 86px;
      right: 18px;
      display: grid;
      gap: 10px;
      z-index: 10;
    }

    .toast {
      background: #ffffff;
      color: var(--ink);
      border-radius: 12px;
      padding: 12px 12px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      min-width: 260px;
      max-width: min(440px, calc(100vw - 40px));
      display: grid;
      grid-template-columns: 34px 1fr auto;
      gap: 10px;
      align-items: start;
      animation: toastIn 0.26s ease both;
      position: relative;
      overflow: hidden;
    }

    .toast::after {
      content: '';
      position: absolute;
      left: 0;
      right: 0;
      bottom: 0;
      height: 3px;
      transform-origin: left;
      transform: scaleX(1);
      background: linear-gradient(90deg, rgba(13, 58, 107, 0.35), rgba(47, 164, 221, 0.25));
      animation: toastLife var(--toast-duration, 2600ms) linear forwards;
    }

    .toast.paused::after { animation-play-state: paused; }

    .toast.out { animation: toastOut 0.18s ease forwards; }

    .toast-icon {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      display: grid;
      place-items: center;
      font-weight: 900;
      font-size: 14px;
      -webkit-user-select: none;
      user-select: none;
    }

    .toast-body { min-width: 0; }
    .toast-title { margin: 0; font-size: 12px; font-weight: 900; letter-spacing: 0.01em; }
    .toast-text { margin: 3px 0 0; font-size: 13px; color: var(--ink-soft); }
    .toast-actions { display: inline-flex; gap: 8px; align-items: center; }

    .toast-btn {
      border: 1px solid var(--border);
      background: #ffffff;
      color: var(--ink);
      border-radius: 10px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 800;
      cursor: pointer;
      transition: transform 90ms ease, box-shadow 140ms ease, background 140ms ease, border-color 140ms ease;
    }

    .toast-btn:hover { box-shadow: 0 10px 18px rgba(15, 23, 42, 0.12); }
    .toast-btn:active { transform: translateY(1px); }

    .toast-btn.action { border-color: rgba(13, 58, 107, 0.25); background: rgba(13, 58, 107, 0.05); }
    .toast-btn.close { padding: 6px 8px; }

    .toast.ok { border-left: 4px solid #22c55e; }
    .toast.warn { border-left: 4px solid #f59e0b; }
    .toast.error { border-left: 4px solid #ef4444; }
    .toast.info { border-left: 4px solid #0ea5e9; }

    .toast.ok .toast-icon { background: rgba(34, 197, 94, 0.14); color: #166534; }
    .toast.warn .toast-icon { background: rgba(245, 158, 11, 0.14); color: #9a3412; }
    .toast.error .toast-icon { background: rgba(239, 68, 68, 0.14); color: #b91c1c; }
    .toast.info .toast-icon { background: rgba(14, 165, 233, 0.14); color: #1d4f91; }

    @keyframes fadeUp {
      from { transform: translateY(8px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.35); opacity: 0.7; }
    }

    @keyframes toastIn {
      from { transform: translateY(-6px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    @keyframes toastOut {
      from { transform: translateY(0); opacity: 1; }
      to { transform: translateY(-6px); opacity: 0; }
    }

    @keyframes toastLife {
      from { transform: scaleX(1); }
      to { transform: scaleX(0); }
    }

    @media (prefers-reduced-motion: reduce) {
      .toast,
      .toast::after,
      button.ghost-btn.hold-done,
      .dot.active {
        animation: none !important;
        transition: none !important;
      }
    }

    @media (max-width: 1100px) {
      .panel-grid { grid-template-columns: 1fr; }
      .right-grid { grid-template-columns: 1fr; }
      .right-grid .card { grid-column: 1 / -1; }
      header { position: static; }
    }

    @media (min-width: 1101px) and (max-width: 1199px) {
      .right-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .right-grid .card { grid-column: auto; }
      .right-grid .card.wide { grid-column: 1 / -1; }
    }

    @media (min-width: 1200px) {
      .right-grid {
        grid-template-areas:
          "stack stack stack stack stack stack stack stack stack stack stack stack"
          "analytics analytics analytics analytics analytics analytics activity activity activity activity activity activity"
          "links links links links links links links links links links links links";
      }

      .stack-card { grid-area: stack; }
      .analytics-card { grid-area: analytics; }
      .activity-card { grid-area: activity; }
      .links-card { grid-area: links; }

      .analytics-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .summary-grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
      .metrics { grid-template-columns: repeat(3, minmax(0, 1fr)); }
      .links { grid-template-columns: repeat(2, minmax(0, 1fr)); }
      .service-list { grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }

    @media (min-width: 1500px) {
      .links { grid-template-columns: repeat(3, minmax(0, 1fr)); }
    }

    #panel-status .panel-grid {
      grid-template-columns: minmax(0, 1fr);
    }

    @media (min-width: 1101px) {
      #panel-status .panel-grid { grid-template-columns: minmax(320px, 420px) minmax(0, 1fr); }
    }

    @media (min-width: 1500px) {
      #panel-status .panel-grid { grid-template-columns: minmax(360px, 520px) minmax(0, 1fr); }
    }

    @media (max-width: 900px) {
      header {
        flex-direction: column;
        align-items: flex-start;
      }

      .header-chips {
        width: 100%;
        justify-content: flex-start;
      }

      .tabs {
        gap: 8px;
      }

      .tab-btn {
        width: 100%;
        justify-content: center;
      }
    }

    @media (max-width: 700px) {
      main { padding: 12px; }
      .card { padding: 14px; }
      .toggle-btn { height: auto; }
    }

    @media (prefers-reduced-motion: reduce) {
      * { animation: none !important; transition: none !important; }
    }

    @media (prefers-contrast: more) {
      .subtitle { opacity: 1; }
      .chip {
        background: rgba(0, 0, 0, 0.42);
        border-color: rgba(255, 255, 255, 0.35);
      }
      .chip.ok { border-color: rgba(34, 197, 94, 0.95); }
      .chip.warn { border-color: rgba(245, 158, 11, 0.95); }
      .chip.error { border-color: rgba(239, 68, 68, 0.95); }
    }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="logo">
        <svg viewBox="0 0 32 32" aria-hidden="true" focusable="false">
          <!-- Birrete -->
          <path class="stroke" d="M16 4l12 5.2-12 5.2L4 9.2 16 4z" />
          <path class="stroke" d="M10 13v3c0 2 2.7 3.8 6 3.8s6-1.8 6-3.8v-3" />
          <path class="stroke" d="M28 9.2v6.8" />
          <circle class="stroke" cx="28" cy="17.6" r="1.2" />

          <!-- Pizarra -->
          <path class="stroke" d="M7 16.5h18a3 3 0 0 1 3 3V26a3 3 0 0 1-3 3H7a3 3 0 0 1-3-3v-6.5a3 3 0 0 1 3-3z" />
          <path class="stroke" d="M9.5 20.5h7" opacity="0.85" />
          <path class="stroke" d="M9.5 23.8h5" opacity="0.75" />

          <!-- Circuito -->
          <path class="accent" d="M10 25.6h5v-2.8h4v2.8h5" />
          <circle class="node n1" cx="10" cy="25.6" r="1.4" />
          <circle class="node n2" cx="15" cy="25.6" r="1.4" />
          <circle class="node n3" cx="19" cy="22.8" r="1.4" />
          <circle class="node n4" cx="24" cy="25.6" r="1.4" />
        </svg>
      </div>
      <div>
        <div class="title">Dashboard - Sistema de Evaluacion Universitaria</div>
        <div class="subtitle">Control local del stack, tareas y salud de servicios</div>
      </div>
    </div>
    <div class="header-chips">
      <span class="chip" id="version-chip">Version: -</span>
      <span class="chip" id="port-chip">Puerto: -</span>
      <span class="chip" id="mode-chip">Modo: -</span>
      <span class="chip" id="running-chip">Procesos: -</span>
      <span class="chip" id="paused-chip">Actualizacion: Activa</span>
      <span class="chip" id="connection-chip">Conexion: -</span>
    </div>
  </header>

  <div class="toast-wrap" id="toast-wrap" role="status" aria-live="polite" aria-atomic="true"></div>

  <main>
    <div class="tabs" role="tablist" aria-label="Secciones del dashboard">
      <button
        id="tab-main"
        class="tab-btn active"
        data-tab="main"
        role="tab"
        aria-selected="true"
        aria-controls="panel-main"
        tabindex="0"
      >
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 4h7v7H4V4zm9 0h7v7h-7V4zM4 13h7v7H4v-7zm9 0h7v7h-7v-7z"/></svg>
        Principal
      </button>
      <button
        id="tab-status"
        class="tab-btn"
        data-tab="status"
        role="tab"
        aria-selected="false"
        aria-controls="panel-status"
        tabindex="-1"
      >
        <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 19h16v2H4v-2zM6 4h4v11H6V4zm6 3h4v8h-4V7z"/></svg>
        Estado y logs
      </button>
    </div>

    <section id="panel-main" class="tab-panel active" data-panel="main" role="tabpanel" tabindex="0" aria-labelledby="tab-main">
      <div class="panel-grid">
        <div class="left-col">
          <div class="card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M8 5v14l11-7L8 5z"/>
              </svg>
              Entornos
            </h2>
            <p class="hint" id="hint-hold">Mantener presionado 1.2s para iniciar/detener o reiniciar. Evita clics accidentales.</p>
            <div class="stack">
              <button class="toggle-btn" data-env="dev" data-hold-ms="1200" aria-pressed="false" aria-describedby="hint-hold">
                <span class="status-dot" data-dot></span>
                <span class="toggle-meta">
                  <span class="toggle-title">Dev local (Docker + Web)</span>
                  <span class="toggle-sub" data-sub>Mantener presionado para iniciar</span>
                </span>
                <span class="toggle-state" data-state>Detenido</span>
              </button>
              <button class="toggle-btn" data-env="prod" data-hold-ms="1200" aria-pressed="false" aria-describedby="hint-hold">
                <span class="status-dot" data-dot></span>
                <span class="toggle-meta">
                  <span class="toggle-title">Prod local (Docker API)</span>
                  <span class="toggle-sub" data-sub>Mantener presionado para iniciar</span>
                </span>
                <span class="toggle-state" data-state>Detenido</span>
              </button>
              <button class="toggle-btn" data-env="portal" data-hold-ms="1200" aria-pressed="false" aria-describedby="hint-hold">
                <span class="status-dot" data-dot></span>
                <span class="toggle-meta">
                  <span class="toggle-title">Portal alumno (API)</span>
                  <span class="toggle-sub" data-sub>Mantener presionado para iniciar</span>
                </span>
                <span class="toggle-state" data-state>Detenido</span>
              </button>
            </div>

            <div class="actions" aria-label="Reinicios">
              <div class="actions-grid env">
                <button class="ghost-btn hold-btn restart-btn" data-restart="dev" data-hold-ms="1200" aria-describedby="hint-hold" type="button" title="Reinicia el entorno dev (Docker + Web)">
                  <span class="btn-row">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12a9 9 0 1 1-3-6.7V3h-6v6h6V6.4A7 7 0 1 0 19 12h2Z"/></svg>
                    <span class="btn-text">Reiniciar dev</span>
                  </span>
                  <span class="btn-sub">Mantener 1.2s</span>
                </button>
                <button class="ghost-btn hold-btn restart-btn" data-restart="prod" data-hold-ms="1200" aria-describedby="hint-hold" type="button" title="Reinicia el entorno prod (Docker API)">
                  <span class="btn-row">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12a9 9 0 1 1-3-6.7V3h-6v6h6V6.4A7 7 0 1 0 19 12h2Z"/></svg>
                    <span class="btn-text">Reiniciar prod</span>
                  </span>
                  <span class="btn-sub">Mantener 1.2s</span>
                </button>
                <button class="ghost-btn hold-btn restart-btn" data-restart="portal" data-hold-ms="1200" aria-describedby="hint-hold" type="button" title="Reinicia la API del portal alumno">
                  <span class="btn-row">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12a9 9 0 1 1-3-6.7V3h-6v6h6V6.4A7 7 0 1 0 19 12h2Z"/></svg>
                    <span class="btn-text">Reiniciar portal</span>
                  </span>
                  <span class="btn-sub">Mantener 1.2s</span>
                </button>
              </div>
              <div class="actions-grid">
                <button class="ghost-btn hold-btn restart-btn" data-restart="stack" data-hold-ms="1200" aria-describedby="hint-hold" type="button" title="Reinicia los servicios activos">
                  <span class="btn-row">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M21 12a9 9 0 1 1-3-6.7V3h-6v6h6V6.4A7 7 0 1 0 19 12h2Z"/></svg>
                    <span class="btn-text">Reiniciar stack</span>
                  </span>
                  <span class="btn-sub">Mantener 1.2s</span>
                </button>
                <button class="ghost-btn hold-btn restart-btn" data-restart="all" data-hold-ms="1200" aria-describedby="hint-hold" type="button" title="Reinicia todos los procesos activos">
                  <span class="btn-row">
                    <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 6V3L8 7l4 4V8c2.8 0 5 2.2 5 5a5 5 0 0 1-9.7 1.6l-1.8.8A7 7 0 1 0 12 6Z"/></svg>
                    <span class="btn-text">Reiniciar todo</span>
                  </span>
                  <span class="btn-sub">Mantener 1.2s</span>
                </button>
              </div>
            </div>
          </div>


        </div>

        <div class="right-grid">
          <div class="card wide stack-card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 4h16v16H4V4zm2 2v4h12V6H6zm0 6v6h12v-6H6z"/>
              </svg>
              Estado del stack
            </h2>
            <div class="summary-grid">
              <div class="summary-card">
                <div class="label">Modo actual</div>
                <div class="value" id="mode">-</div>
              </div>
              <div class="summary-card">
                <div class="label">Entornos activos</div>
                <div class="value" id="running-count">-</div>
              </div>
              <div class="summary-card">
                <div class="label">Procesos activos</div>
                <div class="value" id="running">-</div>
              </div>
              <div class="summary-card">
                <div class="label">Ultima actualizacion</div>
                <div class="value" id="last-refresh">-</div>
              </div>
            </div>
            <div class="status-grid">
              <div>Proyecto: <span id="root">-</span></div>
            </div>
          </div>

          <div class="card analytics-card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 19h16v2H4v-2zM5 5h4v11H5V5zm7 3h4v8h-4V8z"/>
              </svg>
              Analitica rapida
            </h2>
            <p class="hint">Salud y actividad recientes (ventana de 15 min).</p>
            <div class="summary-grid analytics-grid">
              <div class="summary-card">
                <div class="label">Servicios activos</div>
                <div class="value" id="health-ok">-</div>
              </div>
              <div class="summary-card">
                <div class="label">Servicios caidos</div>
                <div class="value" id="health-down">-</div>
              </div>
              <div class="summary-card">
                <div class="label">Eventos recientes (inicio/detencion)</div>
                <div class="value" id="recent-events">-</div>
              </div>
              <div class="summary-card">
                <div class="label">Tiempo de sesion</div>
                <div class="value" id="session-mins">-</div>
              </div>
            </div>
            <p class="hint">Tiempo de sesion = minutos desde que abriste este dashboard en tu navegador.</p>
            <div class="chart-block">
              <div class="chart-title">Servicios monitorizados</div>
              <div class="service-list" id="service-list">
                <div class="service-item" id="service-web-docente">
                  <span class="service-dot" id="service-web-docente-dot"></span>
                  <div class="service-copy">
                    <div class="service-title">Web docente</div>
                    <div class="service-meta">UI local (5173/4173)</div>
                  </div>
                  <span class="service-badge" id="service-web-docente-badge">Sin comprobar</span>
                </div>
                <div class="service-item" id="service-api-docente">
                  <span class="service-dot" id="service-api-docente-dot"></span>
                  <div class="service-copy">
                    <div class="service-title">API docente</div>
                    <div class="service-meta">Backend local (4000)</div>
                  </div>
                  <span class="service-badge" id="service-api-docente-badge">Sin comprobar</span>
                </div>
                <div class="service-item" id="service-api-portal">
                  <span class="service-dot" id="service-api-portal-dot"></span>
                  <div class="service-copy">
                    <div class="service-title">API portal alumno</div>
                    <div class="service-meta">Portal alumno (8080)</div>
                  </div>
                  <span class="service-badge" id="service-api-portal-badge">Sin comprobar</span>
                </div>
              </div>
            </div>
            <div class="chart-block">
              <div class="chart-title">Salud reciente (ultimos ciclos)</div>
              <div class="mini-chart" id="health-history"></div>
              <div class="legend">
                <span class="legend-item"><span class="legend-dot ok"></span>OK</span>
                <span class="legend-item"><span class="legend-dot down"></span>Caida detectada</span>
              </div>
              <div class="hint">Cada barra representa un ciclo (~3s). Altura = % de servicios OK. Naranja = hubo caida.</div>
              <div class="hint" id="last-event">Sin actividad reciente.</div>
            </div>
          </div>

          <div class="card activity-card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 8a4 4 0 100 8 4 4 0 000-8zm0-6a10 10 0 11-7.1 2.9A10 10 0 0112 2zm0 2a8 8 0 100 16 8 8 0 000-16z"/>
              </svg>
              Actividad reciente
            </h2>
            <p class="hint">Registra inicios y detenciones de entornos (dev, prod, portal) detectados por el dashboard.</p>
            <ul class="activity-list" id="activity-list">
              <li class="activity-empty">Sin actividad reciente.</li>
            </ul>
          </div>

          <div class="card wide links-card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M10 6h8v8h-2V9.4l-9.3 9.3-1.4-1.4L14.6 8H10V6z"/>
              </svg>
              Accesos y salud
            </h2>
            <p class="hint">El acceso a la Web Docente se ajusta al modo activo. Dev usa Vite (5173) y prod usa serve (4173).</p>
            <div class="links">
              <div class="link-item" id="web-docente-item">
                <a id="web-docente-link" href="http://localhost:5173" target="_blank" rel="noreferrer noopener">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M3 5h18v14H3V5zm2 2v10h14V7H5z"/></svg>
                  <div class="link-copy">
                    <div class="link-title">Web docente</div>
                    <div class="link-meta" id="web-docente-meta">Dev local (Vite) - 5173</div>
                  </div>
                  <span class="link-chip dev" id="web-docente-chip">DEV</span>
                </a>
                <div class="link-note" id="web-docente-note">Se ajusta al modo activo.</div>
                <div class="link-status">
                  <span class="health-dot" id="health-web-docente-dot"></span>
                  <span class="health-text" id="health-web-docente-text">Sin comprobar</span>
                  <span class="health-latency" id="health-web-docente-latency">--</span>
                </div>
              </div>
              <div class="link-item" id="api-docente-item">
                <a href="http://localhost:4000/api/salud" target="_blank" rel="noreferrer noopener">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 12h4l2-4 4 8 2-4h4"/></svg>
                  <div class="link-copy">
                    <div class="link-title">API docente salud</div>
                    <div class="link-meta">Backend local - 4000</div>
                  </div>
                  <span class="link-chip api">API</span>
                </a>
                <div class="link-note">Disponible cuando el backend docente esta activo.</div>
                <div class="link-status">
                  <span class="health-dot" id="health-api-docente-dot"></span>
                  <span class="health-text" id="health-api-docente-text">Sin comprobar</span>
                  <span class="health-latency" id="health-api-docente-latency">--</span>
                </div>
              </div>
              <div class="link-item" id="api-portal-item">
                <a href="http://localhost:8080/api/portal/salud" target="_blank" rel="noreferrer noopener">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M4 12h4l2-4 4 8 2-4h4"/></svg>
                  <div class="link-copy">
                    <div class="link-title">API portal alumno salud</div>
                    <div class="link-meta">Portal alumno - 8080</div>
                  </div>
                  <span class="link-chip api">API</span>
                </a>
                <div class="link-note">Disponible cuando el portal alumno esta activo.</div>
                <div class="link-status">
                  <span class="health-dot" id="health-api-portal-dot"></span>
                  <span class="health-text" id="health-api-portal-text">Sin comprobar</span>
                  <span class="health-latency" id="health-api-portal-latency">--</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section id="panel-status" class="tab-panel" data-panel="status" role="tabpanel" tabindex="0" aria-labelledby="tab-status" hidden>
      <div class="panel-grid">
        <div>
          <div class="card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M4 4h16v16H4V4zm2 2v4h12V6H6zm0 6v6h12v-6H6z"/>
              </svg>
              Estado general
            </h2>
            <div class="metrics">
              <div class="metric">
                <div class="label">Node</div>
                <div class="value" id="node">-</div>
              </div>
              <div class="metric">
                <div class="label">NPM</div>
                <div class="value" id="npm">-</div>
              </div>
              <div class="metric">
                <div class="label">Docker</div>
                <div class="value" id="docker">-</div>
              </div>
            </div>
            <div class="status-grid">
              <div>Procesos: <span id="running-status">-</span></div>
              <div>Modo: <span id="mode-status">-</span></div>
              <div>Proyecto: <span id="root-status">-</span></div>
              <div>Conexion: <span id="connection-status">-</span></div>
              <div>Ultimo error: <span id="connection-error">-</span></div>
            </div>
          </div>

          <div class="card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M12 2l10 5-10 5L2 7l10-5zm-6 8v6c0 2.2 2.7 4 6 4s6-1.8 6-4v-6" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              Instalacion local
            </h2>
            <div class="install-grid" id="install-grid" aria-live="polite">
              <div class="install-row"><div class="k">Version</div><div class="v mono" id="install-version">-</div></div>
              <div class="install-row"><div class="k">Dashboard</div><div class="v" id="install-dashboard">-</div></div>
              <div class="install-row"><div class="k">Ruta</div><div class="v mono" id="install-root">-</div></div>
              <div class="install-row"><div class="k">Logs</div><div class="v mono" id="install-logs">-</div></div>
              <div class="install-row"><div class="k">Runtime</div><div class="v mono" id="install-runtime">-</div></div>
            </div>
            <div class="toolbar" aria-label="Acciones de instalacion" style="margin-top: 12px; justify-content: flex-end;">
              <button class="ghost-btn" id="refresh-install" type="button">Actualizar</button>
              <button class="ok" id="copy-install" type="button">Copiar</button>
            </div>
          </div>
        </div>

        <div>
          <div class="card">
            <h2>
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M5 5h14v14H5V5zm2 2v10h10V7H7z"/>
              </svg>
              Salida y consola
            </h2>
            <div class="toolbar toolbar-grid" aria-label="Controles de salida">
              <div class="toolbar-group actions" aria-label="Acciones de salida">
                <button class="ok" id="toggle-logs" aria-expanded="false" aria-controls="log-shell">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5l7 7-7 7-1.4-1.4L15.2 13H5v-2h10.2l-4.6-4.6L12 5z"/></svg>
                  Mostrar salida
                </button>
                <button class="ghost-btn" id="open-logfile" type="button" title="Abrir logs/dashboard.log (log persistente)">
                  Abrir dashboard.log
                </button>
                <button class="danger" id="clear-logs">
                  <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M6 7h12v2H6V7zm2 3h8l-1 9H9l-1-9zm3-6h2l1 2H10l1-2z"/></svg>
                  Limpiar salida
                </button>
              </div>

              <div class="toolbar-group switches" aria-label="Opciones de salida">
                <label class="toggle">
                  <input type="checkbox" id="full-logs" />
                  Logs detallados
                </label>
                <label class="toggle">
                  <input type="checkbox" id="auto-scroll" checked />
                  Auto-scroll
                </label>
                <label class="toggle">
                  <input type="checkbox" id="pause-updates" />
                  Pausar actualizaciones
                </label>
                <label class="toggle" title="En modo dev, reinicia el stack cuando cambien archivos del front/back">
                  <input type="checkbox" id="auto-restart" />
                  Auto-reinicio (dev)
                </label>
              </div>

              <div class="toolbar-group filter" aria-label="Filtro de salida">
                <input class="search" id="log-filter" placeholder="Filtrar texto" aria-label="Filtrar salida" />
                <button class="ghost-btn" id="clear-filter" type="button">Limpiar filtro</button>
              </div>
            </div>
            <div class="pills">
              <span class="pill" id="log-size">0 lineas</span>
              <span class="pill" id="raw-size">0 en bruto</span>
              <span class="pill" id="last-refresh-status">-</span>
              <span class="pill"><span class="dot" id="running-dot"></span> activo</span>
            </div>

            <div class="status-events" aria-label="Eventos recientes del sistema">
              <div class="status-events-head">
                <div class="status-events-title">Eventos recientes</div>
                <button class="ghost-btn" id="refresh-events" type="button">Actualizar</button>
              </div>
              <div class="status-events-sub">Acciones y alertas detectadas por el dashboard (inicio/detencion/reinicio/errores). Click para ver detalles.</div>
              <div class="status-events-list" id="status-events">
                <div class="status-event"><div class="msg">Cargando eventos...</div></div>
              </div>
            </div>
            <div class="log-shell collapsed" id="log-shell">
              <div class="log-body" id="log" role="log" aria-label="Salida de consola" aria-live="off">Cargando...</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

    <script>
    // Small helper to access DOM elements.
    const $ = (id) => document.getElementById(id);

    // Small helper to set text safely.
    const setText = (id, value) => {
      const el = $(id);
      if (el) el.textContent = value;
    };

    function normalizeModeValue(value) {
      const v = String(value || '').toLowerCase();
      return v === 'dev' || v === 'prod' || v === 'none' ? v : 'none';
    }

    function deriveDisplayMode(configMode, runningList) {
      const cfg = normalizeModeValue(configMode);
      const running = new Set(Array.isArray(runningList) ? runningList : []);
      const hasDev = running.has('dev');
      const hasProd = running.has('prod');

      // If config explicitly sets dev/prod, respect it.
      if (cfg === 'dev' || cfg === 'prod') return cfg;

      // Otherwise, infer from what's running.
      if (hasDev && !hasProd) return 'dev';
      if (hasProd && !hasDev) return 'prod';
      if (hasDev && hasProd) return 'dev';
      return 'none';
    }

    function formatModeLabel(modeValue) {
      const m = normalizeModeValue(modeValue);
      if (m === 'none') return 'Sin modo';
      return m.toUpperCase();
    }

    const ENV_LABELS = {
      dev: 'Dev local',
      prod: 'Prod local',
      portal: 'Portal alumno'
    };

    const state = {
      showFull: false,
      autoScroll: true,
      paused: false,
      filter: '',
      running: new Set(),
      logsVisible: false,
      activeTab: 'main',
      mode: 'none',
      health: {},
      lastHealthAt: 0,
      events: [],
      healthHistory: [],
      sessionStarted: Date.now(),
      hasLoaded: false,
      webDocenteInfoKey: 'webDocenteDev',
      connection: 'unknown',
      lastConnectionAt: 0,
      lastConnectionError: '',
      lastErrorToastAt: 0,
      lastEventsOk: true,
      lastEventsError: '',
      lastLogsOk: true,
      lastLogsError: '',
      autoRestart: false,
      install: null
    };

    const HOLD_DEFAULT = 1200;
    const MAX_EVENTS = 6;
    const MAX_HEALTH_HISTORY = 16;
    const RECENT_EVENT_WINDOW_MS = 15 * 60 * 1000;
    const SIGNAL_LIMIT = 8;
    const LEVEL_MAP = {
      error: 'error',
      warn: 'warn',
      ok: 'ok',
      info: 'info',
      system: 'info'
    };

    function normalizeErrorMessage(error) {
      if (error && typeof error === 'object' && 'message' in error && typeof error.message === 'string') {
        return error.message;
      }
      return 'Sin respuesta';
    }

    function setConnection(stateName, detail = '') {
      state.connection = stateName;
      state.lastConnectionAt = Date.now();
      state.lastConnectionError = stateName === 'error' ? String(detail || 'Sin respuesta') : '';

      const chip = $('connection-chip');
      if (chip) {
        chip.className = `chip ${stateName === 'ok' ? 'ok' : stateName === 'error' ? 'error' : 'warn'}`;
        chip.textContent = `Conexion: ${stateName === 'ok' ? 'OK' : stateName === 'error' ? 'Error' : '-'}`;
      }

      setText('connection-status', stateName === 'ok' ? 'OK' : stateName === 'error' ? 'Error' : '-');
      setText('connection-error', stateName === 'error'
        ? truncateMessage(state.lastConnectionError, 90)
        : '-');
    }

    function setPausedChip(paused) {
      const chip = $('paused-chip');
      if (!chip) return;
      chip.className = `chip ${paused ? 'warn' : 'ok'}`;
      chip.textContent = paused ? 'Actualizacion: Pausada' : 'Actualizacion: Activa';
    }

    function maybeToastError(text) {
      const now = Date.now();
      if (now - state.lastErrorToastAt < 9000) return;
      state.lastErrorToastAt = now;
      showToast(text, 'error', { title: 'Error', id: 'error-generic', duration: 5200 });
    }

    async function api(path, body) {
      try {
        const res = await fetch(path, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body || {})
        });
        return await res.json();
      } catch (error) {
        maybeToastError('No se pudo contactar al dashboard.');
        setConnection('error', normalizeErrorMessage(error));
        return { ok: false };
      }
    }

    function formatMs(ms) {
      if (!Number.isFinite(ms)) return '-';
      if (ms < 1000) return `${Math.round(ms)}ms`;
      const s = Math.round(ms / 100) / 10;
      if (s < 90) return `${s}s`;
      const m = Math.round(s / 6) / 10;
      return `${m}m`;
    }

    function truncatePath(p, max = 88) {
      const s = String(p || '');
      if (!s) return '-';
      if (s.length <= max) return s;
      return s.slice(0, 22) + '' + s.slice(-Math.max(10, max - 26));
    }

    async function refreshInstallInfo() {
      try {
        const res = await fetch('/api/install');
        if (!res.ok) throw new Error('No se pudo cargar /api/install');
        const info = await res.json();
        state.install = info;

        const version = (info && info.app && info.app.version) ? String(info.app.version) : '-';
        const name = (info && info.app && info.app.name) ? String(info.app.name) : '';
        const port = info && info.dashboard ? info.dashboard.port : 0;
        const mode = info && info.dashboard ? String(info.dashboard.mode || '-') : '-';
        const pid = info && info.dashboard ? String(info.dashboard.pid || '-') : '-';
        const startedAt = info && info.dashboard ? Number(info.dashboard.startedAt || 0) : 0;

        const logs = info && info.paths ? String(info.paths.logFile || '') : '';
        const root = info && info.paths ? String(info.paths.root || '') : '';
        const runtime = info && info.runtime ? `${info.runtime.nodeVersion || ''} | ${info.runtime.platform || ''}/${info.runtime.arch || ''}` : '';

        const logCfg = info && info.logs ? info.logs : null;
        const persist = logCfg ? String(logCfg.persistMode || '-') : '-';
        const flushMs = logCfg ? Number(logCfg.flushMs || 0) : 0;
        const keep = logCfg ? Number(logCfg.keepFiles || 0) : 0;
        const maxBytes = logCfg ? Number(logCfg.maxBytes || 0) : 0;

        const startedAgo = startedAt ? formatMs(Date.now() - startedAt) : '-';

        const modeLabel = mode === '-' ? '-' : formatModeLabel(normalizeModeValue(mode));

        setText('install-version', name && version !== '-' ? `${name} v${version}` : (version !== '-' ? `v${version}` : '-'));
        setText('install-dashboard', `Modo: ${modeLabel}  Puerto: ${port || '-'}  PID: ${pid}  Inicio: hace ${startedAgo}`);
        setText('install-root', truncatePath(root, 96));
        setText('install-logs', `${truncatePath(logs, 96)}\nPersistencia: ${persist}  Flush: ${flushMs ? flushMs + 'ms' : '-'}  Rotacion: ${maxBytes ? Math.round(maxBytes/1000) + 'KB' : '-'}  Keep: ${keep || '-'}`);
        setText('install-runtime', truncatePath(runtime, 110));

        const versionChip = $('version-chip');
        if (versionChip) versionChip.textContent = `Version: ${version !== '-' ? version : '-'}`;
        const portChip = $('port-chip');
        if (portChip) portChip.textContent = `Puerto: ${port || '-'}`;
      } catch (error) {
        setText('install-version', '-');
        setText('install-dashboard', 'No se pudo cargar la info de instalacion.');
        maybeToastError('No se pudo cargar la info de instalacion.');
      }
    }

    function showToast(text, type = 'info', options = {}) {
      return showToastAdvanced(String(text || ''), type, options || {});
    }

    function toastIcon(type) {
      if (type === 'ok') return 'OK';
      if (type === 'warn') return '!';
      if (type === 'error') return 'X';
      return 'i';
    }

    function cssEscape(value) {
      if (typeof value !== 'string') return '';
      if (window.CSS && typeof window.CSS.escape === 'function') return window.CSS.escape(value);
      return value.replace(/"/g, '\\"');
    }

    function dismissToast(toast) {
      if (!toast || toast.classList.contains('out')) return;
      toast.classList.add('out');
      const remove = () => toast.remove();
      toast.addEventListener('animationend', remove, { once: true });
      setTimeout(remove, 260);
    }

    function showToastAdvanced(text, type = 'info', options = {}) {
      const wrap = $('toast-wrap');
      if (!wrap) return;

      const title = typeof options.title === 'string' ? options.title : null;
      const id = typeof options.id === 'string' ? options.id : null;
      const actionLabel = typeof options.actionLabel === 'string' ? options.actionLabel : null;
      const onAction = typeof options.onAction === 'function' ? options.onAction : null;
      const duration = Math.max(1200, Number(options.duration || 2800));
      const maxToasts = 4;

      if (id) {
        const existing = wrap.querySelector(`.toast[data-id="${cssEscape(id)}"]`);
        if (existing) existing.remove();
      }

      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.style.setProperty('--toast-duration', `${duration}ms`);
      if (id) toast.dataset.id = id;

      const safeTitle = title || (type === 'error' ? 'Error' : type === 'warn' ? 'Atencion' : type === 'ok' ? 'Listo' : 'Info');

      toast.innerHTML = `
        <div class="toast-icon" aria-hidden="true">${toastIcon(type)}</div>
        <div class="toast-body">
          <div class="toast-title">${safeTitle}</div>
          <div class="toast-text"></div>
        </div>
        <div class="toast-actions">
          ${actionLabel ? '<button class="toast-btn action" type="button" data-toast-action></button>' : ''}
          <button class="toast-btn close" type="button" aria-label="Cerrar" data-toast-close></button>
        </div>
      `.trim();

      const textEl = toast.querySelector('.toast-text');
      if (textEl) textEl.textContent = String(text || '').trim();
      const actionBtn = toast.querySelector('[data-toast-action]');
      if (actionBtn && actionLabel) actionBtn.textContent = actionLabel;

      const closeBtn = toast.querySelector('[data-toast-close]');
      if (closeBtn) closeBtn.addEventListener('click', () => dismissToast(toast));
      if (actionBtn && onAction) {
        actionBtn.addEventListener('click', () => {
          try { onAction(); } finally { dismissToast(toast); }
        });
      }

      wrap.appendChild(toast);
      while (wrap.children.length > maxToasts) {
        const first = wrap.firstElementChild;
        if (first) first.remove();
      }

      let remaining = duration;
      let startedAt = Date.now();
      let timer = setTimeout(() => dismissToast(toast), remaining);

      const pause = () => {
        if (!timer) return;
        clearTimeout(timer);
        timer = null;
        remaining -= Date.now() - startedAt;
        toast.classList.add('paused');
      };

      const resume = () => {
        if (timer) return;
        remaining = Math.max(450, remaining);
        startedAt = Date.now();
        toast.classList.remove('paused');
        timer = setTimeout(() => dismissToast(toast), remaining);
      };

      toast.addEventListener('pointerenter', pause);
      toast.addEventListener('pointerleave', resume);

      return toast;
    }

    function showToastAdvancedEntry(text, type, options) {
      return showToastAdvanced(text, type, options);
    }

    function refreshAfterAction({ forceHealth = true } = {}) {
      refreshStatus();
      if (forceHealth) refreshHealth(true);
      if (state.logsVisible) refreshLogs();
      refreshSignals();
      if (state.activeTab === 'status') refreshEvents();
    }

    function scheduleRefreshPulse() {
      refreshAfterAction({ forceHealth: true });
      setTimeout(() => refreshAfterAction({ forceHealth: true }), 900);
      setTimeout(() => refreshAfterAction({ forceHealth: true }), 2400);
      setTimeout(() => refreshAfterAction({ forceHealth: true }), 5200);
    }

    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function normalizeLevel(level) {
      return LEVEL_MAP[level] || 'info';
    }

    function truncateMessage(text, limit = 140) {
      if (!text) return '';
      if (text.length <= limit) return text;
      return text.slice(0, limit).trim() + '...';
    }

    function renderAlert(entry) {
      const card = $('alert-card');
      if (!card) return;
      const icon = $('alert-icon');
      const title = $('alert-title');
      const message = $('alert-message');
      const source = $('alert-source');
      const time = $('alert-time');
      if (!icon || !title || !message || !source || !time) return;

      if (!entry) {
        card.className = 'card wide alert-card ok';
        icon.textContent = 'OK';
        title.textContent = 'Sin alertas activas';
        message.textContent = 'No hay errores recientes en los servicios monitoreados.';
        source.textContent = 'Origen: -';
        time.textContent = 'Hora: -';
        return;
      }

      const level = normalizeLevel(entry.level);
      const isError = level === 'error';
      card.className = `card wide alert-card ${isError ? 'error' : ''}`.trim();
      icon.textContent = isError ? 'X' : '!';
      title.textContent = isError ? 'Error detectado' : 'Advertencia detectada';
      message.textContent = truncateMessage(entry.text, 220);
      source.textContent = `Origen: ${entry.source || '-'}`;
      time.textContent = `Hora: ${entry.time || '-'}`;
    }

    function renderSignalCounts(counts) {
      setText('signal-error', String(counts.error || 0));
      setText('signal-warn', String(counts.warn || 0));
      setText('signal-ok', String(counts.ok || 0));
      setText('signal-info', String(counts.info || 0));
    }

    function renderEventFeed(entries) {
      const feed = $('event-feed');
      if (!feed) return;
      feed.innerHTML = '';

      if (!entries.length) {
        const empty = document.createElement('li');
        empty.className = 'event-empty';
        empty.textContent = 'Sin mensajes recientes.';
        feed.appendChild(empty);
        return;
      }

      entries.forEach((entry) => {
        const level = normalizeLevel(entry.level);
        const item = document.createElement('li');
        item.className = `event-item ${level}`.trim();

        const dot = document.createElement('span');
        dot.className = 'event-dot';

        const text = document.createElement('div');
        text.className = 'event-text';

        const title = document.createElement('div');
        title.textContent = truncateMessage(entry.text, 160);

        const meta = document.createElement('div');
        meta.className = 'event-meta';

        const metaLevel = document.createElement('span');
        metaLevel.textContent = `Nivel: ${level.toUpperCase()}`;
        const metaSource = document.createElement('span');
        metaSource.textContent = `Origen: ${entry.source || '-'}`;

        meta.appendChild(metaLevel);
        meta.appendChild(metaSource);
        text.appendChild(title);
        text.appendChild(meta);

        const time = document.createElement('span');
        time.className = 'event-time';
        time.textContent = entry.time || '-';

        item.appendChild(dot);
        item.appendChild(text);
        item.appendChild(time);
        feed.appendChild(item);
      });
    }

    function updateSignals(entries) {
      const counts = { error: 0, warn: 0, ok: 0, info: 0 };
      const safeEntries = Array.isArray(entries) ? entries : [];

      safeEntries.forEach((entry) => {
        const level = normalizeLevel(entry.level);
        if (level === 'error') counts.error += 1;
        else if (level === 'warn') counts.warn += 1;
        else if (level === 'ok') counts.ok += 1;
        else counts.info += 1;
      });

      renderSignalCounts(counts);

      const latestEntries = safeEntries.slice(-SIGNAL_LIMIT).reverse();
      renderEventFeed(latestEntries);

      const critical = [...safeEntries].reverse().find((entry) => {
        const level = normalizeLevel(entry.level);
        return level === 'error' || level === 'warn';
      });

      renderAlert(critical || null);
    }

    async function refreshSignals() {
      try {
        const res = await fetch('/api/logs');
        const data = await res.json();
        state.lastLogsOk = true;
        state.lastLogsError = '';
        updateSignals(data.entries || []);
      } catch (error) {
        state.lastLogsOk = false;
        state.lastLogsError = normalizeErrorMessage(error);
        updateSignals([]);
      }
    }

    function setRunningDot(active) {
      const dot = $('running-dot');
      if (!dot) return;
      dot.classList.toggle('active', active);
    }

    function setHealthItem(prefix, info, expected = true) {
      const dot = $(`health-${prefix}-dot`);
      const text = $(`health-${prefix}-text`);
      const latency = $(`health-${prefix}-latency`);
      if (!dot || !text || !latency) return;

      if (!expected) {
        dot.className = 'health-dot';
        text.textContent = 'Detenido';
        latency.textContent = '--';
        return;
      }

      if (!info || typeof info.ok !== 'boolean') {
        dot.className = 'health-dot';
        text.textContent = 'Sin comprobar';
        latency.textContent = '--';
        return;
      }

      const ok = info.ok;
      const statusLabel = ok ? 'Activo' : (info.status ? `Caido (HTTP ${info.status})` : 'Sin respuesta');
      dot.className = `health-dot ${ok ? 'ok' : 'down'}`;
      text.textContent = statusLabel;
      latency.textContent = typeof info.ms === 'number' ? `${info.ms} ms` : '--';
    }

    function renderRunning(list) {
      if (!Array.isArray(list) || list.length === 0) return '-';
      return list.map((item) => ENV_LABELS[item] || item).join(', ');
    }

    function updateEnvButton(button, running) {
      if (!button) return;
      const stateEl = button.querySelector('[data-state]');
      const subEl = button.querySelector('[data-sub]');

      button.classList.toggle('active', running);
      button.classList.remove('pending');
      button.removeAttribute('data-pending');

      if (stateEl) stateEl.textContent = running ? 'Activo' : 'Detenido';
      if (subEl) {
        subEl.textContent = running
          ? 'Mantener presionado para detener'
          : 'Mantener presionado para iniciar';
      }

      button.setAttribute('aria-pressed', running ? 'true' : 'false');
    }

    function updateEnvButtons() {
      document.querySelectorAll('[data-env]').forEach((button) => {
        updateEnvButton(button, state.running.has(button.dataset.env));
      });
    }

    function recordEvent(type, label) {
      const entry = {
        id: `${Date.now()}-${Math.random().toString(16).slice(2)}`,
        type,
        label,
        time: Date.now()
      };

      state.events.unshift(entry);
      if (state.events.length > MAX_EVENTS) {
        state.events.splice(MAX_EVENTS);
      }

      renderActivity();
      updateAnalytics();
    }

    function renderActivity() {
      const list = $('activity-list');
      if (!list) return;

      list.innerHTML = '';

      if (state.events.length === 0) {
        const empty = document.createElement('li');
        empty.className = 'activity-empty';
        empty.textContent = 'Sin actividad reciente.';
        list.appendChild(empty);
        setText('last-event', 'Sin actividad reciente.');
        return;
      }

      state.events.forEach((entry) => {
        const li = document.createElement('li');
        li.className = 'activity-item';

        const dot = document.createElement('span');
        dot.className = `activity-dot ${entry.type === 'start' ? 'ok' : 'down'}`;

        const text = document.createElement('span');
        text.className = 'activity-text';
        text.textContent = `${entry.type === 'start' ? 'Inicio' : 'Detencion'}: ${entry.label}`;

        const time = document.createElement('span');
        time.className = 'activity-time';
        time.textContent = formatTime(entry.time);

        li.appendChild(dot);
        li.appendChild(text);
        li.appendChild(time);
        list.appendChild(li);
      });

      const last = state.events[0];
      if (last) {
        setText('last-event', `Ultima accion: ${last.label} (${last.type === 'start' ? 'inicio' : 'detenido'})`);
      }
    }

    function getServiceSnapshot() {
      const runningDevOrProd = state.running.has('dev') || state.running.has('prod');
      const webInfoKey = state.webDocenteInfoKey || 'webDocenteDev';
      const items = [
        {
          id: 'web-docente',
          expected: runningDevOrProd,
          info: state.health?.[webInfoKey]
        },
        {
          id: 'api-docente',
          expected: runningDevOrProd,
          info: state.health?.apiDocente
        },
        {
          id: 'api-portal',
          expected: state.running.has('portal'),
          info: state.health?.apiPortal
        }
      ];

      let okCount = 0;
      let downCount = 0;

      items.forEach((item) => {
        if (!item.expected) return;
        if (!item.info || typeof item.info.ok !== 'boolean') return;
        if (item.info.ok) okCount += 1;
        else downCount += 1;
      });

      return { items, okCount, downCount };
    }

    function updateServiceSummary() {
      const snapshot = getServiceSnapshot();

      snapshot.items.forEach((item) => {
        const dot = $(`service-${item.id}-dot`);
        const badge = $(`service-${item.id}-badge`);
        if (!dot || !badge) return;

        if (!item.expected) {
          dot.className = 'service-dot';
          badge.className = 'service-badge';
          badge.textContent = 'Detenido';
          return;
        }

        if (!item.info || typeof item.info.ok !== 'boolean') {
          dot.className = 'service-dot';
          badge.className = 'service-badge';
          badge.textContent = 'Sin comprobar';
          return;
        }

        if (item.info.ok) {
          dot.className = 'service-dot ok';
          badge.className = 'service-badge ok';
          badge.textContent = 'Activo';
        } else {
          dot.className = 'service-dot down';
          badge.className = 'service-badge down';
          badge.textContent = 'Caido';
        }
      });

      return snapshot;
    }

    function renderHealthHistory() {
      const container = $('health-history');
      if (!container) return;

      container.innerHTML = '';

      if (state.healthHistory.length === 0) {
        const empty = document.createElement('div');
        empty.className = 'chart-empty';
        empty.textContent = 'Sin historial de salud por ahora.';
        container.appendChild(empty);
        return;
      }

      state.healthHistory.forEach((entry) => {
        const ratio = entry.total ? entry.okCount / entry.total : 0;
        const height = Math.max(10, Math.round(12 + ratio * 52));
        const bar = document.createElement('div');
        bar.className = `mini-bar ${entry.downCount > 0 ? 'down' : ''}`.trim();
        bar.style.height = `${height}px`;
        bar.title = `${formatTime(entry.ts)} | OK ${entry.okCount}/${entry.total}`;
        container.appendChild(bar);
      });
    }

    function updateAnalytics() {
      const snapshot = updateServiceSummary();
      const expectedTotal = snapshot.items.filter((item) => item.expected).length;

      setText('health-ok', expectedTotal ? String(snapshot.okCount) : '-');
      setText('health-down', expectedTotal ? String(snapshot.downCount) : '-');

      const now = Date.now();
      const recentEvents = state.events.filter((entry) => now - entry.time <= RECENT_EVENT_WINDOW_MS).length;
      setText('recent-events', String(recentEvents));

      const minutes = Math.floor((now - state.sessionStarted) / 60000);
      setText('session-mins', minutes < 1 ? '<1 min' : `${minutes} min`);
    }

    function buildHealthSnapshot() {
      const snapshot = getServiceSnapshot();
      const expectedTotal = snapshot.items.filter((item) => item.expected).length;
      if (!expectedTotal) return null;

      return {
        ts: Date.now(),
        okCount: snapshot.okCount,
        downCount: snapshot.downCount,
        total: expectedTotal
      };
    }

    function updateWebDocenteLink(mode) {
      const item = $('web-docente-item');
      const link = $('web-docente-link');
      const meta = $('web-docente-meta');
      const chip = $('web-docente-chip');
      const note = $('web-docente-note');
      if (!item || !link || !meta || !chip || !note) return;

      const runningDev = state.running.has('dev');
      const runningProd = state.running.has('prod');
      const normalized = String(mode || '').toLowerCase();

      let target = 'dev';
      if (runningDev && !runningProd) target = 'dev';
      else if (runningProd && !runningDev) target = 'prod';
      else if (runningDev && runningProd) target = normalized === 'prod' ? 'prod' : 'dev';
      else target = normalized === 'prod' ? 'prod' : 'dev';

      const isProd = target === 'prod';
      link.href = isProd ? 'http://localhost:4173' : 'http://localhost:5173';
      meta.textContent = isProd
        ? 'Prod local (Docker + serve) - 4173'
        : 'Dev local (Vite) - 5173';
      chip.textContent = isProd ? 'PROD' : 'DEV';
      chip.className = `link-chip ${isProd ? 'prod' : 'dev'}`;

      const any = runningDev || runningProd;
      item.classList.toggle('inactive', !any);

      if (!any) {
        note.textContent = 'No hay UI web activa. Inicia dev (5173) o prod (4173).';
      } else if (runningDev && runningProd) {
        note.textContent = `Dev y prod activos. Mostrando ${isProd ? 'prod' : 'dev'} segun el modo actual.`;
      } else {
        note.textContent = `Detectado ${isProd ? 'prod' : 'dev'} activo. Acceso listo.`;
      }

      const infoKey = isProd ? 'webDocenteProd' : 'webDocenteDev';
      state.webDocenteInfoKey = infoKey;
      setHealthItem('web-docente', state.health?.[infoKey], any);
    }

    async function refreshHealth(force = false) {
      const now = Date.now();
      const reuse = !force && now - state.lastHealthAt < 4000;
      if (!reuse) state.lastHealthAt = now;

      if (!reuse) {
        try {
          const res = await fetch('/api/health');
          const data = await res.json();
          state.health = data.services || {};
        } catch {
          state.health = {};
        }

        const snapshot = buildHealthSnapshot();
        if (snapshot) {
          state.healthHistory.push(snapshot);
          if (state.healthHistory.length > MAX_HEALTH_HISTORY) {
            state.healthHistory.splice(0, state.healthHistory.length - MAX_HEALTH_HISTORY);
          }
          renderHealthHistory();
        }
      }

      const runningDevOrProd = state.running.has('dev') || state.running.has('prod');
      setHealthItem('api-docente', state.health.apiDocente, runningDevOrProd);
      setHealthItem('api-portal', state.health.apiPortal, state.running.has('portal'));
      updateWebDocenteLink(state.mode);
      updateAnalytics();
    }

    function setLogsVisible(visible) {
      state.logsVisible = visible;
      const shell = $('log-shell');
      const toggle = $('toggle-logs');
      if (!shell || !toggle) return;
      shell.classList.toggle('collapsed', !visible);
      toggle.setAttribute('aria-expanded', visible ? 'true' : 'false');
      toggle.innerHTML = '<svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M12 5l7 7-7 7-1.4-1.4L15.2 13H5v-2h10.2l-4.6-4.6L12 5z"/></svg> ' + (visible ? 'Ocultar salida' : 'Mostrar salida');
      if (visible) refreshLogs();
      else refreshSignals();
    }

    function setTab(name) {
      state.activeTab = name;
      document.querySelectorAll('.tab-btn').forEach((btn) => {
        const isActive = btn.dataset.tab === name;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
        btn.tabIndex = isActive ? 0 : -1;
      });
      document.querySelectorAll('.tab-panel').forEach((panel) => {
        const isActive = panel.dataset.panel === name;
        panel.classList.toggle('active', isActive);
        panel.hidden = !isActive;
      });
      if (name === 'status') {
        refreshEvents();
        refreshInstallInfo();
        if (state.logsVisible) refreshLogs();
      }
    }

    function renderStatusEvents(entries) {
      const wrap = $('status-events');
      if (!wrap) return;
      wrap.innerHTML = '';

      if (!state.lastEventsOk) {
        const item = document.createElement('div');
        item.className = 'status-event error';
        item.innerHTML = `<div class="msg">Sin conexion: no se pudieron obtener eventos.</div>`;
        wrap.appendChild(item);
        return;
      }

      const safe = Array.isArray(entries) ? entries : [];
      const max = 10;
      const sliced = safe.slice(0, max);
      if (sliced.length === 0) {
        const item = document.createElement('div');
        item.className = 'status-event';
        item.innerHTML = `<div class="msg">Aun no hay eventos.</div>`;
        wrap.appendChild(item);
        return;
      }

      const fragment = document.createDocumentFragment();
      sliced.forEach((evt) => {
        const level = evt.level || 'info';
        const el = document.createElement('div');
        const hasMeta = evt.meta && typeof evt.meta === 'object';
        el.className = `status-event ${level} ${hasMeta ? 'has-meta' : ''}`.trim();

        const type = typeof evt.type === 'string' ? evt.type : 'evento';
        const source = typeof evt.source === 'string' ? evt.source : '-';
        const time = typeof evt.time === 'string' ? evt.time : '-';
        const text = typeof evt.text === 'string' ? evt.text : '';

        el.innerHTML = `
          <div class="top">
            <span class="time">${time}</span>
            <span class="tag">${type}</span>
            <span class="tag">${source}</span>
          </div>
          <div class="msg"></div>
          <div class="meta"></div>
        `.trim();

        const msg = el.querySelector('.msg');
        if (msg) msg.textContent = text;

        const meta = el.querySelector('.meta');
        if (meta && hasMeta) {
          try { meta.textContent = JSON.stringify(evt.meta, null, 2); } catch { meta.textContent = ''; }
        }

        if (hasMeta) {
          el.addEventListener('click', () => {
            el.classList.toggle('open');
          });
        }

        fragment.appendChild(el);
      });

      wrap.appendChild(fragment);
    }

    async function refreshEvents() {
      if (state.activeTab !== 'status') return;
      try {
        const res = await fetch('/api/events');
        const data = await res.json();
        state.lastEventsOk = true;
        state.lastEventsError = '';
        renderStatusEvents(data.entries || []);
      } catch (error) {
        state.lastEventsOk = false;
        state.lastEventsError = normalizeErrorMessage(error);
        renderStatusEvents([]);
      }
    }

    function attachHold(button, onTrigger) {
      let rafId = null;
      let start = 0;
      const holdMs = Number(button.dataset.holdMs || HOLD_DEFAULT);
      let active = false;

      const reset = () => {
        button.style.setProperty('--hold', 0);
        button.classList.remove('is-holding');
        active = false;
        if (rafId) cancelAnimationFrame(rafId);
        rafId = null;
      };

      const step = (now) => {
        const progress = Math.min(1, (now - start) / holdMs);
        button.style.setProperty('--hold', (progress * 100).toFixed(2));
        if (progress >= 1) {
          button.classList.add('hold-done');
          setTimeout(() => button.classList.remove('hold-done'), 420);
          reset();
          onTrigger();
          return;
        }
        rafId = requestAnimationFrame(step);
      };

      const startHold = (event) => {
        event.preventDefault();
        const cooldownUntil = Number(button.dataset.cooldownUntil || 0);
        if (cooldownUntil && Date.now() < cooldownUntil) return;
        if (active) return;
        active = true;
        button.classList.add('is-holding');
        start = performance.now();
        rafId = requestAnimationFrame(step);
      };

      const cancelHold = () => {
        if (!active) return;
        reset();
      };

      button.addEventListener('pointerdown', startHold);
      button.addEventListener('pointerup', cancelHold);
      button.addEventListener('pointerleave', cancelHold);
      button.addEventListener('pointercancel', cancelHold);
      button.addEventListener('keydown', (event) => {
        if (event.key === 'Enter' || event.key === ' ') startHold(event);
      });
      button.addEventListener('keyup', cancelHold);
    }

    function syncEnvEvents(previous, current) {
      previous.forEach((env) => {
        if (!current.has(env)) recordEvent('stop', ENV_LABELS[env] || env);
      });
      current.forEach((env) => {
        if (!previous.has(env)) recordEvent('start', ENV_LABELS[env] || env);
      });
    }

    async function refreshStatus() {
      try {
        const res = await fetch('/api/status');
        const data = await res.json();
        setConnection('ok');

      const runningList = Array.isArray(data.running) ? data.running : [];
      const runningCount = runningList.length;
      const previousRunning = new Set(state.running);

      const displayMode = deriveDisplayMode(data.mode, runningList);
      state.mode = displayMode;
      state.running = new Set(runningList);

      setText('root', data.root);
      setText('mode', formatModeLabel(displayMode));
      setText('running-count', String(runningCount));
      setText('running', renderRunning(runningList));
      setText('last-refresh', `Actualizado ${new Date().toLocaleTimeString()}`);

      setText('root-status', data.root);
      setText('mode-status', formatModeLabel(displayMode));
      setText('running-status', renderRunning(runningList));
      setText('node', data.node);
      setText('npm', data.npm);
      setText('docker', data.docker);
      setText('mode-chip', `Modo: ${formatModeLabel(displayMode)}`);
      setText('running-chip', `Procesos: ${runningCount}`);
      setText('port-chip', `Puerto: ${data.port || '-'}`);
      setText('log-size', `${data.logSize} lineas`);
      setText('raw-size', `${data.rawSize} en bruto`);
      setText('last-refresh-status', `Actualizado ${new Date().toLocaleTimeString()}`);

      state.autoRestart = Boolean(data.autoRestart);
      const autoRestartToggle = $('auto-restart');
      if (autoRestartToggle) {
        autoRestartToggle.disabled = String(data.modeConfig || data.mode || '').toLowerCase() !== 'dev';
        autoRestartToggle.checked = state.autoRestart;
      }

      setRunningDot(runningCount > 0);
      updateEnvButtons();

      if (state.hasLoaded) {
        syncEnvEvents(previousRunning, state.running);
      }
      state.hasLoaded = true;

      const apiDocenteItem = $('api-docente-item');
      if (apiDocenteItem) {
        apiDocenteItem.classList.toggle('inactive', !(state.running.has('dev') || state.running.has('prod')));
      }
      const apiPortalItem = $('api-portal-item');
      if (apiPortalItem) {
        apiPortalItem.classList.toggle('inactive', !state.running.has('portal'));
      }

        await refreshHealth();
      } catch (error) {
        setConnection('error', normalizeErrorMessage(error));
        maybeToastError('Sin conexion: no se pudo leer /api/status.');

        state.running = new Set();
        state.mode = 'none';
        state.health = {};

        setText('root', '-');
        setText('mode', '-');
        setText('running-count', '0');
        setText('running', '-');
        setText('last-refresh', '-');

        setText('root-status', '-');
        setText('mode-status', '-');
        setText('running-status', '-');
        setText('node', '-');
        setText('npm', '-');
        setText('docker', '-');
        setText('mode-chip', 'Modo: -');
        setText('running-chip', 'Procesos: -');

        setRunningDot(false);
        updateEnvButtons();
        updateWebDocenteLink(state.mode);
        updateAnalytics();

        renderAlert({
          level: 'error',
          text: 'No hay conexion con el servidor del dashboard. Inicia scripts/launcher-dashboard para habilitar /api/*.',
          source: 'dashboard',
          time: new Date().toLocaleTimeString()
        });
      }
    }

    async function setAutoRestart(value) {
      await api('/api/config', { autoRestart: Boolean(value) });
      refreshStatus();
    }

    function renderLogs(entries) {
      const filter = state.filter.trim().toLowerCase();
      const log = $('log');
      if (!log) return;
      log.innerHTML = '';

      if (!state.lastLogsOk) {
        const offline = document.createElement('div');
        offline.className = 'log-line';
        offline.textContent = 'Sin conexion: no se pudo obtener la salida de logs.';
        log.appendChild(offline);
        return;
      }

      const safeEntries = Array.isArray(entries) ? entries : [];
      const totalEntries = safeEntries.length;

      const fragment = document.createDocumentFragment();
      let visible = 0;

      safeEntries.forEach((entry) => {
        const metaText = entry && entry.meta && typeof entry.meta === 'object'
          ? (() => { try { return JSON.stringify(entry.meta); } catch { return ''; } })()
          : '';
        const text = `${entry.time} ${entry.source} ${entry.level} ${entry.text} ${metaText}`;
        if (filter && !text.toLowerCase().includes(filter)) return;

        const line = document.createElement('div');
        const hasMeta = entry && entry.meta && typeof entry.meta === 'object';
        line.className = `log-line ${entry.level} ${hasMeta ? 'has-meta' : ''}`.trim();

        const meta = document.createElement('span');
        meta.className = 'meta';
        meta.textContent = `[${entry.time}] [${entry.source}]`;

        const tags = document.createElement('span');
        tags.className = 'meta-tag';
        const pill = document.createElement('span');
        pill.className = 'pill';
        pill.textContent = String(entry.level || 'info').toUpperCase();
        tags.appendChild(pill);

        const content = document.createElement('span');
        content.textContent = ` ${entry.text}`;

        line.appendChild(meta);
        line.appendChild(tags);
        line.appendChild(content);

        if (hasMeta) {
          const details = document.createElement('div');
          details.className = 'meta-json';
          try { details.textContent = JSON.stringify(entry.meta, null, 2); } catch { details.textContent = ''; }
          line.appendChild(details);
          line.addEventListener('click', () => {
            line.classList.toggle('open');
          });
        }

        fragment.appendChild(line);
        visible += 1;
      });

      if (visible === 0) {
        const empty = document.createElement('div');
        empty.className = 'log-line';
        if (totalEntries === 0 && !filter) {
          empty.textContent = 'Aun no hay logs. Inicia un entorno o espera actividad.';
        } else {
          empty.textContent = 'Sin salida para el filtro actual.';
        }
        fragment.appendChild(empty);
      }

      log.appendChild(fragment);

      if (state.autoScroll) {
        log.scrollTop = log.scrollHeight;
      }
    }

    async function refreshLogs() {
      if (!state.logsVisible) return;
      try {
        const query = state.showFull ? '/api/logs?full=1' : '/api/logs';
        const res = await fetch(query);
        const data = await res.json();
        const entries = data.entries || [];
        state.lastLogsOk = true;
        state.lastLogsError = '';
        renderLogs(entries);
        updateSignals(entries);
      } catch (error) {
        state.lastLogsOk = false;
        state.lastLogsError = normalizeErrorMessage(error);
        maybeToastError('No se pudo obtener la salida de logs.');
        renderLogs([]);
        updateSignals([]);
      }
    }

    // Tab switching.
    const tabButtons = Array.from(document.querySelectorAll('.tab-btn'));
    tabButtons.forEach((button, index) => {
      button.addEventListener('click', () => setTab(button.dataset.tab));
      button.addEventListener('keydown', (event) => {
        const key = event.key;
        if (!['ArrowLeft', 'ArrowRight', 'Home', 'End', 'Enter', ' '].includes(key)) return;
        event.preventDefault();

        const last = tabButtons.length - 1;
        const go = (nextIndex) => {
          const next = tabButtons[nextIndex];
          next.focus();
          setTab(next.dataset.tab);
        };

        if (key === 'ArrowLeft') go(index === 0 ? last : index - 1);
        if (key === 'ArrowRight') go(index === last ? 0 : index + 1);
        if (key === 'Home') go(0);
        if (key === 'End') go(last);
        if (key === 'Enter' || key === ' ') setTab(button.dataset.tab);
      });
    });

    // Toggle buttons for environments (hold to start/stop).
    document.querySelectorAll('[data-env]').forEach((button) => {
      attachHold(button, () => {
        const env = button.dataset.env;
        const running = state.running.has(env);
        button.dataset.cooldownUntil = String(Date.now() + 2200);
        button.dataset.pending = running ? 'stop' : 'start';
        button.classList.add('pending');
        const subEl = button.querySelector('[data-sub]');
        if (subEl) subEl.textContent = running ? 'Deteniendo...' : 'Iniciando...';

        showToast(running ? `Deteniendo ${env}...` : `Iniciando ${env}...`, 'info', {
          id: `env-${env}-pending`,
          title: 'Accion solicitada',
          duration: 3200,
          actionLabel: 'Abrir logs',
          onAction: () => {
            setTab('status');
            setLogsVisible(true);
            refreshLogs();
          }
        });

        const endpoint = running ? '/api/stop' : '/api/start';
        api(endpoint, { task: env }).then((res) => {
          if (res && res.ok === false) {
            showToast(`No se pudo ejecutar la accion en ${env}.`, 'error', {
              id: `env-${env}-error`,
              title: 'Error',
              duration: 5200
            });
            return;
          }
          showToast('Solicitud enviada. Actualizando estado...', 'ok', {
            id: `env-${env}-sent`,
            title: 'Listo',
            duration: 2200
          });
          scheduleRefreshPulse();
        });
      });
    });

    // Restart buttons (hold-to-run).
    document.querySelectorAll('[data-restart][data-hold-ms]').forEach((button) => {
      attachHold(button, () => {
        const what = button.dataset.restart;
        button.dataset.cooldownUntil = String(Date.now() + 6500);
        button.classList.add('pending');

        showToast(`Reiniciando ${what}...`, 'warn', {
          id: `restart-${what}-pending`,
          title: 'Reinicio',
          duration: 4200,
          actionLabel: 'Ver estado',
          onAction: () => {
            setTab('status');
            refreshStatus();
            refreshHealth(true);
          }
        });

        api('/api/restart', { task: what }).then((res) => {
          if (res && res.ok === false) {
            showToast(`No se pudo reiniciar ${what}.`, 'error', {
              id: `restart-${what}-error`,
              title: 'Error',
              duration: 5200
            });
            button.classList.remove('pending');
            return;
          }
          showToast('Reinicio solicitado. Actualizando...', 'ok', {
            id: `restart-${what}-sent`,
            title: 'Listo',
            duration: 2400
          });
          scheduleRefreshPulse();
          setTimeout(() => button.classList.remove('pending'), 6500);
        });
      });
    });

    // Hold-to-run for destructive actions.
    document.querySelectorAll('[data-run][data-hold-ms]').forEach((button) => {
      attachHold(button, () => {
        const task = button.dataset.run;
        button.dataset.cooldownUntil = String(Date.now() + 2500);
        button.classList.add('pending');
        showToast('Ejecutando accion segura...', 'warn', {
          id: `run-${task}-pending`,
          title: 'Accion segura',
          duration: 3800,
          actionLabel: 'Abrir logs',
          onAction: () => {
            setTab('status');
            setLogsVisible(true);
            refreshLogs();
          }
        });
        api('/api/run', { task }).then((res) => {
          if (res && res.ok === false) {
            showToast('No se pudo ejecutar la accion.', 'error', { id: `run-${task}-error`, title: 'Error', duration: 5200 });
            button.classList.remove('pending');
            return;
          }
          showToast('Accion enviada. Actualizando...', 'ok', { id: `run-${task}-sent`, title: 'Listo', duration: 2200 });
          scheduleRefreshPulse();
          setTimeout(() => button.classList.remove('pending'), 2500);
        });
      });
    });

    // Immediate run for non-destructive actions.
    document.querySelectorAll('[data-run]:not([data-hold-ms])').forEach((button) => {
      button.addEventListener('click', () => {
        const task = button.dataset.run;
        button.dataset.cooldownUntil = String(Date.now() + 1200);
        showToast('Ejecutando...', 'info', { id: `run-${task}-pending`, title: 'Accion', duration: 2600 });
        api('/api/run', { task }).then((res) => {
          if (res && res.ok === false) {
            showToast('No se pudo ejecutar.', 'error', { id: `run-${task}-error`, title: 'Error', duration: 5200 });
            return;
          }
          showToast('Accion enviada. Actualizando...', 'ok', { id: `run-${task}-sent`, title: 'Listo', duration: 2000 });
          scheduleRefreshPulse();
        });
      });
    });

    const clearButton = $('clear-logs');
    if (clearButton) {
      clearButton.addEventListener('click', async () => {
        await api('/api/logs/clear');
        showToast('Logs limpiados', 'ok');
        refreshLogs();
        refreshStatus();
        refreshSignals();
      });
    }

    const toggleLogsButton = $('toggle-logs');
    if (toggleLogsButton) {
      toggleLogsButton.addEventListener('click', () => {
        setLogsVisible(!state.logsVisible);
      });
    }

    const alertOpenLogs = $('alert-open-logs');
    if (alertOpenLogs) {
      alertOpenLogs.addEventListener('click', () => {
        setTab('status');
        setLogsVisible(true);
      });
    }

    // UI toggles.
    const fullLogs = $('full-logs');
    if (fullLogs) {
      fullLogs.addEventListener('change', (event) => {
        state.showFull = event.target.checked;
        refreshLogs();
      });
    }

    const autoScroll = $('auto-scroll');
    if (autoScroll) {
      autoScroll.addEventListener('change', (event) => {
        state.autoScroll = event.target.checked;
      });
    }

    const pauseUpdates = $('pause-updates');
    if (pauseUpdates) {
      pauseUpdates.addEventListener('change', (event) => {
        state.paused = event.target.checked;
        setPausedChip(state.paused);
        showToast(state.paused ? 'Actualizaciones pausadas' : 'Actualizaciones reanudadas', state.paused ? 'warn' : 'ok');
      });
    }

    const autoRestartToggle = $('auto-restart');
    if (autoRestartToggle) {
      autoRestartToggle.addEventListener('change', (event) => {
        const value = event.target.checked;
        showToast(value ? 'Auto-reinicio activado' : 'Auto-reinicio desactivado', value ? 'ok' : 'warn');
        setAutoRestart(value);
      });
    }

    const logFilter = $('log-filter');
    if (logFilter) {
      logFilter.addEventListener('input', (event) => {
        state.filter = event.target.value;
        refreshLogs();
      });
    }

    const clearFilter = $('clear-filter');
    if (clearFilter) {
      clearFilter.addEventListener('click', () => {
        state.filter = '';
        const input = $('log-filter');
        if (input) input.value = '';
        refreshLogs();
      });
    }

    const openLogFile = $('open-logfile');
    if (openLogFile) {
      openLogFile.addEventListener('click', () => {
        window.open('/api/logfile', '_blank', 'noopener,noreferrer');
      });
    }

    const refreshEventsBtn = $('refresh-events');
    if (refreshEventsBtn) {
      refreshEventsBtn.addEventListener('click', () => refreshEvents());
    }

    const refreshInstallBtn = $('refresh-install');
    if (refreshInstallBtn) {
      refreshInstallBtn.addEventListener('click', () => refreshInstallInfo());
    }

    const copyInstallBtn = $('copy-install');
    if (copyInstallBtn) {
      copyInstallBtn.addEventListener('click', async () => {
        try {
          const info = state.install ? JSON.stringify(state.install, null, 2) : 'Sin datos de instalacion.';
          if (navigator.clipboard && navigator.clipboard.writeText) {
            await navigator.clipboard.writeText(info);
          } else {
            const ta = document.createElement('textarea');
            ta.value = info;
            ta.style.position = 'fixed';
            ta.style.left = '-9999px';
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            ta.remove();
          }
          showToast('Datos de instalacion copiados', 'ok', { id: 'install-copied', title: 'Copiado', duration: 2200 });
        } catch {
          showToast('No se pudo copiar al portapapeles', 'warn', { id: 'install-copy-fail', title: 'Aviso', duration: 3200 });
        }
      });
    }

    // Initial load and periodic refresh.
    setTab(state.activeTab);
    setPausedChip(false);
    setConnection('unknown');
    setLogsVisible(false);
    renderActivity();
    renderHealthHistory();
    refreshStatus();
    refreshInstallInfo();
    refreshSignals();

    setInterval(() => {
      if (state.paused) return;
      refreshStatus();
      if (state.logsVisible) refreshLogs();
      else refreshSignals();
      if (state.activeTab === 'status') refreshEvents();
    }, 3000);
  </script>
</body>
</html>













































































